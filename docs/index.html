<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weekly Workout Planner</title>
  <meta name="color-scheme" content="light dark"/>
  <link rel="stylesheet" href="assets/tw.css?v=2"/>
  <style>
/* ==== unified tokens ==== */
:root{
  /* tabs/panel (light) */
  --panelBg: #fff;
  --tabBorder: rgb(203 213 225);      /* slate-300 */
  --tabInactiveBg: rgb(248 250 252);  /* slate-50 */
  --tabInactiveFg: rgb(71 85 105);    /* slate-600 */

  /* inputs (light) */
  --inputBg: #fff;
  --inputFg: rgb(15 23 42);           /* slate-900 */
  --inputBd: rgb(226 232 240);        /* slate-200 */
}

/* dark scheme — matches Tailwind's media dark mode */
@media (prefers-color-scheme: dark){
  :root{
    --panelBg: rgb(30 41 59);         /* slate-800 */
    --tabBorder: rgb(51 65 85);       /* slate-700 */
    --tabInactiveBg: rgb(30 41 59);   /* slate-800 (softer, not white) */
    --tabInactiveFg: rgb(203 213 225);/* slate-300 */

    --inputBg: rgb(15 23 42);         /* slate-900 */
    --inputFg: rgb(226 232 240);      /* slate-200/300 */
    --inputBd: rgb(51 65 85);         /* slate-700 */
  }
}

/* ==== tabs look/feel ==== */
.tabs{ border-bottom:1px solid var(--tabBorder); }
.tab{
  background: var(--tabInactiveBg);
  color: var(--tabInactiveFg);
  border:1px solid var(--tabBorder);
  border-bottom:none;
}
.tab[aria-selected="true"]{
  background: var(--panelBg);
  color: inherit;
  border-color: var(--tabBorder);
  z-index:2;
}
.tabpanel{
  background: var(--panelBg);
  border:1px solid var(--tabBorder);
  border-top:none;
  border-bottom-left-radius:.75rem;
  border-bottom-right-radius:.75rem;
}

/* ==== inputs/selects/textarea inside panels ==== */
/* Use .tabpanel to add specificity and beat utility classes */
.tabpanel input,
.tabpanel select,
.tabpanel textarea{
  background: var(--inputBg) !important;
  color: var(--inputFg) !important;
  border: 1px solid var(--inputBd) !important;
}
.tabpanel input::placeholder,
.tabpanel textarea::placeholder{ color: color-mix(in oklab, var(--inputFg) 55%, transparent); }
.tabpanel select option{ color: initial; } /* keep native options readable */

/* day pill buttons in dark mode (for consistency) */
@media (prefers-color-scheme: dark){
  .day-tabs button{
    background: rgb(30 41 59);
    color: rgb(203 213 225);
    border-color: var(--tabBorder);
  }
  .day-tabs button:hover{ background: rgb(51 65 85); }
  .day-tabs button[aria-selected="true"]{ background: var(--panelBg); color:#fff; }
}


    :root{--ring:0 0 0 2px rgba(37,99,235,.35)}
    .card{border-radius:.75rem}
    .field{display:flex;flex-direction:column;gap:.45rem}
    .lbl{font-size:.85rem;line-height:1.1rem;color:rgb(100 116 139)}
    .inp{width:100%;padding:.6rem .7rem;border-radius:.6rem;border:1px solid rgb(203 213 225)}
    .inp.dark{border-color:rgb(51 65 85);background:rgb(15 23 42)}
    .inp:focus{outline:none;box-shadow:var(--ring)}
    .sm-btn{padding:.5rem .75rem;border-radius:.55rem;border:1px solid rgb(203 213 225)}
    .row-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:.75rem}
   /* Day tabs: selected vs inactive, with dark-mode contrast */
    .day-tabs button[aria-selected="true"]{
      background: rgb(15 23 42);      /* slate-900 */
      color: #fff;
      border-color: rgb(15 23 42);
    }
    .day-tabs button{
      background: rgb(226 232 240);   /* slate-200 */
      color: rgb(15 23 42);           /* slate-900 */
    }
    .day-tabs button:hover{ filter: brightness(0.95); }

    /* Dark mode inactive tabs: readable text on dark bg */
    .dark .day-tabs button{
      background: rgb(30 41 59);      /* slate-800 */
      color: rgb(203 213 225);        /* slate-300 */
    }
    .dark .day-tabs button:hover{
      background: rgb(51 65 85);      /* slate-700 */
    }
    /* Top-level tabs (Plan / Load & Save / Upload / Settings) */
    [role="tab"][aria-selected="true"]{
      background: rgb(37 99 235);     /* blue-600 */
      border-color: rgb(37 99 235);
      color: #fff;
    }
    [role="tab"][aria-selected="false"]{
      background: rgb(226 232 240);
      color: rgb(15 23 42);
    }
    .dark [role="tab"][aria-selected="false"]{
      background: rgb(30 41 59);
      color: rgb(203 213 225);
    }
    /* Toasts */
    #toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:.5rem;z-index:60}
    .toast{padding:.6rem .8rem;border-radius:.6rem;color:white}
    .toast-ok{background:#10b981}
    .toast-warn{background:#f59e0b}
    .toast-err{background:#ef4444}
    /* Modal */
    #modal{position:fixed;inset:0;z-index:50;display:none}
    #modal.show{display:block}

    /* ===== Top Nav Tabs ===== */
    :root{
      --panelBg: #fff;
      --tabBorder: rgb(203 213 225);   /* slate-300 */
      --tabInactiveBg: rgb(248 250 252); /* slate-50 */
      --tabInactiveFg: rgb(71 85 105);   /* slate-600 */
    }
    .dark{
      --panelBg: rgb(30 41 59);        /* slate-800 */
      --tabBorder: rgb(51 65 85);      /* slate-700 */
      --tabInactiveBg: rgb(15 23 42);  /* slate-900 */
      --tabInactiveFg: rgb(203 213 225); /* slate-300 */
    }
/* Light defaults already set above via :root … */

/* ---- Dark-mode overrides (media-based, to match Tailwind CDN) ---- */
@media (prefers-color-scheme: dark){
  :root{
    /* Panels & tabs */
    --panelBg: rgb(30 41 59);        /* slate-800 */
    --tabBorder: rgb(51 65 85);      /* slate-700 */
    --tabInactiveBg: rgb(15 23 42);  /* slate-900 */
    --tabInactiveFg: rgb(203 213 225); /* slate-300 */

    /* Button system */
    --btnSecBg:  rgb(30 41 59);      /* slate-800 */
    --btnSecFg:  rgb(203 213 225);   /* slate-300 */
    --btnSecBd:  rgb(51 65 85);      /* slate-700 */
    --btnOlFg:   rgb(203 213 225);   /* slate-300 */
    --btnOlBd:   rgb(51 65 85);      /* slate-700 */
  }

  /* Top tabs & panel borders pick up dark vars automatically,
     but ensure we don’t inherit light colors anywhere */
  .tab{ background: var(--tabInactiveBg); color: var(--tabInactiveFg); border-color: var(--tabBorder); }
  .tabpanel{ background: var(--panelBg); border-color: var(--tabBorder); }

  /* Day tabs contrast in dark mode */
  .day-tabs button{
    background: rgb(30 41 59);       /* slate-800 */
    color: rgb(203 213 225);         /* slate-300 */
    border-color: var(--tabBorder);
  }
  .day-tabs button:hover{ background: rgb(51 65 85); } /* slate-700 */
  .day-tabs button[aria-selected="true"]{
    background: var(--panelBg);
    color: #fff; /* or keep inherit if you prefer */
  }
}

    .tabs{
      display:flex; gap:.4rem; align-items:flex-end;
      border-bottom:1px solid var(--tabBorder);
      overflow-x:auto; -webkit-overflow-scrolling:touch;
      padding:0 .25rem;
    }
    .tabs::-webkit-scrollbar{ height:6px }
    .tabs::-webkit-scrollbar-thumb{ background:rgba(100,116,139,.35); border-radius:9999px }

    .tab{
      position:relative; top:1px; /* lift onto the panel border */
      padding:.55rem .9rem; font-weight:600;
      border:1px solid var(--tabBorder); border-bottom:none;
      border-top-left-radius:.6rem; border-top-right-radius:.6rem;
      background:var(--tabInactiveBg); color:var(--tabInactiveFg);
      transition: filter .15s ease, background .15s ease, color .15s ease;
      white-space:nowrap;
    }
    .tab:hover{ filter:brightness(.98) }
    .tab:focus{ outline: none; box-shadow: 0 0 0 2px rgba(37,99,235,.35); border-color: rgba(37,99,235,.55); }

    /* Active tab sits “on” the panel */
    .tab[aria-selected="true"]{
      background:var(--panelBg); color:inherit;
      z-index:2;
    }

    /* Panel that sits under tabs */
    .tabpanel{
      background:var(--panelBg);
      border:1px solid var(--tabBorder);
      border-top:none; /* connect to the active tab edge */
      border-bottom-left-radius:.75rem; border-bottom-right-radius:.75rem;
    }

    /* ---------- Unified button system ---------- */
    :root{
      --btnPrimaryBg: rgb(37 99 235);   /* blue-600 */
      --btnDangerBg:  rgb(220 38 38);   /* red-600  */
      --btnSecBg:     rgb(226 232 240); /* slate-200 */
      --btnSecFg:     rgb(15 23 42);    /* slate-900 */
      --btnSecBd:     rgb(203 213 225); /* slate-300 */
      --btnOlFg:      rgb(51 65 85);    /* slate-700 */
      --btnOlBd:      rgb(203 213 225); /* slate-300 */
    }
    
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:.55rem .9rem; border-radius:.6rem; font-weight:600;
      border:1px solid var(--btnSecBd); transition:filter .15s ease,opacity .15s;
    }
    .btn:hover{ filter:brightness(0.97); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-primary{ background:var(--btnPrimaryBg); color:#fff; border-color:var(--btnPrimaryBg); }
    .btn-secondary{ background:var(--btnSecBg); color:var(--btnSecFg); border-color:var(--btnSecBd); }
    .btn-outline{ background:transparent; color:var(--btnOlFg); border-color:var(--btnOlBd); }
    .btn-danger{ background:var(--btnDangerBg); color:#fff; border-color:var(--btnDangerBg); }
    .btn-ghost{ background:transparent; border-color:transparent; }

    /* Tabs: force our colors to win over any utility classes */
.tabs .tab{
  background: var(--tabInactiveBg) !important;
  color: var(--tabInactiveFg) !important;
  border-color: var(--tabBorder) !important;
}
.tabs .tab[aria-selected="true"]{
  background: var(--panelBg) !important;
  color: inherit !important; /* or #fff if you prefer */
  border-color: var(--tabBorder) !important;
}
/* ---- Stronger active-tab styling ---- */
:root{
  /* brand accent (light) */
  --tabActiveAccent: rgb(37 99 235);   /* blue-600 */
  --tabActiveText:   rgb(100 124 201);   /* blue-800 */
}
@media (prefers-color-scheme: dark){
  /* brighter accent for dark backgrounds */
  --tabActiveAccent: rgb(96 165 250);  /* blue-400 */
  --tabActiveText:   rgb(100 124 201); /* blue-200 */
 /* --tabActiveText:   rgb(191 219 254); /* blue-200 */
}

/* Base tab colors already set; make active tab stand out */
.tabs .tab[aria-selected="true"]{
  background: var(--panelBg) !important;                 /* keep connected look */
  color: var(--tabActiveText) !important;                /* colored label */
  font-weight: 700;                                      /* bolder text */
  border-color: var(--tabBorder) !important;
  border-top: 3px solid var(--tabActiveAccent) !important; /* accent bar */
  padding-top: calc(.55rem - 2px);                       /* compensate for thicker top */
  box-shadow: 0 1px 0 0 var(--panelBg);                  /* clean edge to panel */
}

/* Slight tint on hover for any tab */
.tabs .tab:hover{
  /* subtle tint; falls back to no tint if color-mix unsupported */
  background: color-mix(in oklab, var(--panelBg) 94%, var(--tabActiveAccent)) !important;
}

/* Keep inactive tabs soft in dark mode */
@media (prefers-color-scheme: dark){
  .tabs .tab[aria-selected="false"]{
    background: var(--tabInactiveBg) !important;
    color: var(--tabInactiveFg) !important;
    border-color: var(--tabBorder) !important;
  }
}

  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <!-- Error banner -->
  <div id="errBanner" class="hidden bg-rose-600 text-white text-sm px-4 py-2"></div>

  <!-- Toasts -->
  <div id="toasts"></div>

  <!-- Modal -->
  <div id="modal" class="bg-black/40">
    <div class="max-w-lg mx-auto mt-28 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl">
      <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-700">
        <div id="modalTitle" class="text-lg font-semibold">Confirm</div>
      </div>
      <div id="modalBody" class="px-4 py-3 text-sm"></div>
      <div class="px-4 py-3 flex justify-end gap-2">
        <button id="modalCancel" class="btn btn-outline">Cancel</button>
        <button id="modalOk" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <header class="bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex items-center justify-between gap-4">
      <h1 class="text-2xl font-semibold tracking-tight">Weekly Workout Planner</h1>
      <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
        <span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800">1) Plan</span>→
        <span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800">2) Save / Load</span>→
        <span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800">3) Upload</span>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800">
      <!-- Tab headers -->
      <div class="px-3 pt-2">
        <nav class="tabs" role="tablist" aria-label="Planner tabs">
          <button class="tab" role="tab" data-tab="plan"      aria-selected="true">Plan</button>
          <button class="tab" role="tab" data-tab="loadsave"  aria-selected="false">Load & Save</button>
          <button class="tab" role="tab" data-tab="upload"    aria-selected="false">Intervals Upload</button>
          <button class="tab" role="tab" data-tab="settings"  aria-selected="false">Settings</button>
        </nav>
      </div>

      <!-- Tab: Plan -->
      <section id="tab-plan" role="tabpanel" class="tabpanel p-4 space-y-6">
        <!-- Week toolbar -->
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
            <label class="field">
              <span class="lbl">Week start (Monday)</span>
              <input id="weekStart" type="date" class="inp dark"/>
            </label>
            <label class="field">
              <span class="lbl">Time zone (IANA)</span>
              <input id="tz" type="text" value="America/Los_Angeles" class="inp dark"/>
            </label>
            <label class="field">
              <span class="lbl">Athlete ID</span>
              <input id="athleteId" type="number" value="0" class="inp dark"/>
            </label>
            <div class="flex items-end">
              <button id="newWeekBtn" class="btn btn-secondary w-full">Clear week</button>

            </div>
          </div>
        </div>

        <!-- Phase & Template -->
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <label class="field">
              <span class="lbl">Macro-phase</span>
              <select id="phase" class="inp dark"><option>Base</option><option>Build</option><option>Specialty</option></select>
            </label>
            <label class="field">
              <span class="lbl">Week focus</span>
              <select id="focus" class="inp dark"><option>Build</option><option>Recovery</option></select>
            </label>
            <label class="field md:col-span-2">
              <span class="lbl">Template</span>
              <select id="templateKey" class="inp dark"><option value="">— choose phase & focus —</option></select>
              <div id="templateDesc" class="mt-1 text-xs text-slate-500"></div>
            </label>
            <div class="flex items-end">
              <button id="loadTemplateBtn" class="btn btn-primary w-full">Load template</button>
            </div>
          </div>
        </div>

        <!-- Day tabs -->
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800">
          <div class="p-3 border-b border-slate-200 dark:border-slate-800 day-tabs flex gap-2 flex-wrap">
            <button class="sm-btn" data-daytab="0" aria-selected="true">Mon</button>
            <button class="sm-btn" data-daytab="1">Tue</button>
            <button class="sm-btn" data-daytab="2">Wed</button>
            <button class="sm-btn" data-daytab="3">Thu</button>
            <button class="sm-btn" data-daytab="4">Fri</button>
            <button class="sm-btn" data-daytab="5">Sat</button>
            <button class="sm-btn" data-daytab="6">Sun</button>
            <div class="ml-auto flex gap-2">
              <button class="btn btn-outline" id="copyPrevDayBtn">Copy prev</button>
              <button class="btn btn-outline" id="clearDayBtn">Clear day</button>
              <button class="btn btn-primary" id="addRowBtn">Add workout</button>
            </div>
          </div>
          <div class="p-4" id="dayEditor"><!-- rows render here --></div>
        </div>

        <!-- Totals -->
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
          <h3 class="text-lg font-semibold mb-3">Totals</h3>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
              <div class="text-xs text-slate-500">Planned Time</div>
              <div id="totPlannedTime" class="text-base font-semibold">0h 00m</div>
            </div>
            <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
              <div class="text-xs text-slate-500">Planned TSS</div>
              <div id="totPlannedTss" class="text-base font-semibold">0</div>
            </div>
            <div class="col-span-2 p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
              <div class="text-xs text-slate-500 mb-1">By Type</div>
              <div id="totByType" class="text-sm leading-6">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tab: Load & Save -->
      <section id="tab-loadsave" role="tabpanel" class="tabpanel p-4 space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
            <h3 class="text-lg font-semibold mb-3">Save current plan to repo</h3>
            <button id="saveRepoBtn" class="btn btn-primary">Save to repo</button>
       </div>
          <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
            <h3 class="text-lg font-semibold mb-3">Export / Import</h3>
            <div class="flex gap-2">
              <button id="exportBtn" class="btn btn-secondary">Export JSON</button>
              <label class="field">
                <span class="lbl">Import JSON</span>
                <input id="importFile" type="file" accept="application/json" class="text-sm"/>
              </label>
            </div>
          </div>
        </div>

        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Load a plan from repo</h3>
            <div class="flex gap-2">
              <button id="testGhBtn" class="btn btn-outline">Test GitHub</button>
              <button id="refreshPlansBtn" class="btn btn-outline">Refresh</button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 mt-3">
            <select id="loadPlanSelect" class="sm:col-span-3 inp dark"><option value="">— select plan —</option></select>
              <button id="loadPlanBtn" class="btn btn-primary">Load</button>
            <a id="openPlanLink" href="#" target="_blank" class="btn btn-outline">Open on GitHub</a>
          </div>
          <div id="loadPlanMsg" class="text-xs text-slate-500 mt-2"></div>
        </div>
      </section>

      <!-- Tab: Intervals Upload -->
     <section id="tab-upload" role="tabpanel" class="tabpanel p-4 space-y-6">

      <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
        <h3 class="text-lg font-semibold mb-2">Upload this week’s plan</h3>
        <p class="text-sm text-slate-500 mb-4">
          Select the day(s) you want to upload. We’ll save a filtered plan file and trigger <code>upload-week-plan.yml</code>.
        </p>

        <!-- Day checkboxes -->
        <div class="mb-3 flex flex-wrap gap-3 items-center">
          <label class="inline-flex items-center gap-2">
            <input id="upSelectAll" type="checkbox" class="h-4 w-4" checked>
              <button id="upWeekdays" class="btn btn-outline">Weekdays</button>
              <button id="upWeekend"  class="btn btn-outline">Weekend</button>

            <span>Select all</span>
          </label>
          <div class="flex flex-wrap gap-3">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="0" checked><span>Mon</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="1" checked><span>Tue</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="2" checked><span>Wed</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="3" checked><span>Thu</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="4" checked><span>Fri</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="5" checked><span>Sat</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="h-4 w-4" data-upday="6" checked><span>Sun</span>
            </label>
          </div>
        </div>
       <button id="uploadIntervalsBtn" class="btn btn-primary">Upload to Intervals</button>
        <div class="text-xs text-slate-500 mt-3" id="uploadHint"></div>
      </div>
    </section>


      <!-- Tab: Settings -->
      <section id="tab-settings" role="tabpanel" class="tabpanel p-4 space-y-6">
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
          <h3 class="text-lg font-semibold mb-3">GitHub settings</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="field"><span class="lbl">Personal Access Token (fine-grained)</span><input id="ghToken" type="password" placeholder="ghp_…" class="inp dark"/></label>
            <label class="field"><span class="lbl">Owner</span><input id="ghOwner" value="tomeese" class="inp dark"/></label>
            <label class="field"><span class="lbl">Repo</span><input id="ghRepo" value="intervals-icu-bulk-uploader-planned-workouts" class="inp dark"/></label>
            <label class="field"><span class="lbl">Branch</span><input id="ghBranch" value="main" class="inp dark"/></label>
            <label class="field"><span class="lbl">Path prefix</span><input id="ghPrefix" value="plans" class="inp dark"/></label>
          </div>
          <div class="flex items-center gap-2 mt-3">
            <button id="saveGhCfg" class="btn btn-primary">Save settings</button>
            <span id="saveGhMsg" class="text-xs text-emerald-500"></span>
            <button id="clearGhCfg" class="btn btn-danger">Clear token</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Workout row template -->
  <template id="rowTpl">
    <div class="py-4 border-b border-slate-100 dark:border-slate-900 last:border-0">
      <div class="row-grid">
        <label class="field col-span-6">
          <span class="lbl">Name</span>
          <input type="text" class="inp dark" placeholder="Endurance Z2 - 2h" data-name/>
        </label>
        <label class="field col-span-3">
          <span class="lbl">Type</span>
          <select class="inp dark" data-type>
            <option>Ride</option><option>Gravel Ride</option><option>Virtual Ride</option>
          </select>
        </label>
        <label class="field col-span-3">
          <span class="lbl">Indoor</span>
          <input type="checkbox" class="h-5 w-5 mt-2" data-indoor/>
        </label>

        <label class="field col-span-3">
          <span class="lbl">Duration (HH:MM)</span>
          <input type="text" inputmode="numeric" pattern="^\\d{1,2}:[0-5]\\d$" placeholder="HH:MM" class="inp dark" value="01:00" data-duration/>
        </label>
        <label class="field col-span-3">
          <span class="lbl">TSS</span>
          <input type="number" min="0" step="1" class="inp dark" value="50" data-tss/>
        </label>
        <label class="field col-span-6">
          <span class="lbl">Notes</span>
          <input type="text" class="inp dark" placeholder="Optional" data-notes/>
        </label>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 justify-end">
        <button class="btn btn-outline" data-design-btn>Design</button>
        <button class="btn btn-secondary" data-zwo>ZWO</button>
        <button class="btn btn-danger" data-del>Delete</button>
      </div>

      <!-- DESIGN panel -->
      <div class="hidden rounded-lg border border-slate-200 dark:border-slate-700 p-3 bg-slate-50 dark:bg-slate-900 mt-3" data-design-panel>
        <div class="text-xs text-slate-500 mb-2">Workout design (saved into JSON for ZWO)</div>
        <div class="row-grid">
          <label class="field col-span-3"><span class="lbl">FTP (W)</span><input type="number" min="50" max="600" step="1" class="inp dark" data-d-ftp></label>
          <label class="field col-span-3"><span class="lbl">Sets</span><input type="number" min="1" max="20" step="1" class="inp dark" data-d-sets></label>
          <label class="field col-span-3"><span class="lbl">Work (sec)</span><input type="number" min="15" max="7200" step="5" class="inp dark" data-d-work></label>
          <label class="field col-span-3"><span class="lbl">Rest (sec)</span><input type="number" min="10" max="7200" step="5" class="inp dark" data-d-rec></label>

          <label class="field col-span-3"><span class="lbl">Target %FTP</span><input type="number" min="0.3" max="1.8" step="0.01" placeholder="0.95" class="inp dark" data-d-target></label>
          <label class="field col-span-3"><span class="lbl">Over/Under</span><input type="checkbox" class="h-5 w-5 mt-2" data-d-ou></label>
          <label class="field col-span-3"><span class="lbl">Under %FTP</span><input type="number" min="0.3" max="1.5" step="0.01" placeholder="0.95" class="inp dark" data-d-under></label>
          <label class="field col-span-3"><span class="lbl">Over %FTP</span><input type="number" min="0.3" max="1.8" step="0.01" placeholder="1.05" class="inp dark" data-d-over></label>

          <label class="field col-span-3"><span class="lbl">Warmup (sec)</span><input type="number" min="60" max="3600" step="30" placeholder="600" class="inp dark" data-d-warm></label>
          <label class="field col-span-3"><span class="lbl">Cooldown (sec)</span><input type="number" min="60" max="3600" step="30" placeholder="600" class="inp dark" data-d-cool></label>
          <label class="field col-span-3"><span class="lbl">Cadence (rpm)</span><input type="number" min="50" max="130" step="1" class="inp dark" data-d-cad></label>
          <label class="field col-span-3"><span class="lbl">ERG</span><input type="checkbox" class="h-5 w-5 mt-2" data-d-erg checked></label>
        </div>
        <div class="mt-2 flex gap-2 justify-end">
          <button class="btn btn-outline" data-design-cancel>Close</button>
          <button class="btn btn-primary" data-design-save>Save</button>
       </div>
      </div>
    </div>
  </template>

  <script>
  // ---------- Error banner ----------
  function showErr(msg){const b=document.getElementById('errBanner');b.textContent=String(msg||'Unknown error');b.classList.remove('hidden');console.error('[planner]', msg);}
  window.addEventListener('error', e=>showErr(e.message||e));

  // ---------- Toasts ----------
  function toast(msg, kind='ok', ms=2600){
    const box=document.getElementById('toasts');
    const div=document.createElement('div');
    div.className='toast '+(kind==='ok'?'toast-ok':kind==='warn'?'toast-warn':'toast-err');
    div.textContent=msg;
    box.appendChild(div);
    setTimeout(()=>{div.remove();}, ms);
  }

  // ---------- Modal confirm ----------
  function confirmDialog({title,html}){
    return new Promise(resolve=>{
      const m=document.getElementById('modal');
      document.getElementById('modalTitle').textContent=title||'Confirm';
      document.getElementById('modalBody').innerHTML=html||'Are you sure?';
      const onCancel=()=>{m.classList.remove('show'); cleanup(); resolve(false);};
      const onOk=()=>{m.classList.remove('show'); cleanup(); resolve(true);};
      function cleanup(){ok.removeEventListener('click',onOk); cancel.removeEventListener('click',onCancel);}
      const ok=document.getElementById('modalOk'); const cancel=document.getElementById('modalCancel');
      ok.addEventListener('click',onOk); cancel.addEventListener('click',onCancel);
      m.classList.add('show');
    });
  }

  // ---------- Utilities ----------
  const $=s=>document.querySelector(s);
  const dayNames=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const fmtHMS=sec=>{sec=Math.max(0,Math.round(sec));const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60);return `${h}h ${String(m).padStart(2,'0')}m`;};
  const parseHHMM=v=>{const m=String(v||'').trim().match(/^(\d{1,2}):([0-5]\d)$/); if(!m) return 0; return parseInt(m[1],10)*3600+parseInt(m[2],10)*60;};
  const normalizeHHMM=s=>{const m=String(s||'').trim().match(/^(\d{1,2}):([0-5]\d)$/); if(!m) return s; return `${m[1].padStart(2,'0')}:${m[2]}`;};
  const mondayOf=date=>{const d=new Date(date);const gd=d.getDay();const diff=(gd===0?-6:1-gd);d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;};
  const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;};
  const toISODate=d=>d.toISOString().slice(0,10);
  const hhmmFromSec=s=>{s=Math.max(0,Math.round(s));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;};
  const numOrNull=x=>{const v=Number(x);return Number.isFinite(v)?v:null;};
  const defaultTargetPctByName=n=>/sweet\s*spot/i.test(n||'')?0.88:/threshold/i.test(n||'')?0.95:/vo2/i.test(n||'')?1.2:/anaerobic|sprint/i.test(n||'')?1.5:0.9;
  const safeFilename=name=>(name||'file').replace(/[^\w\-.]+/g,'_').slice(0,120);
  const base64EncodeUTF8=str=>btoa(unescape(encodeURIComponent(str)));
  const encodePathPreserveSlashes=p=>p.split('/').map(encodeURIComponent).join('/');

  // Escapes plain text for safe HTML insertion
  function escHtml(s){ return String(s ?? '').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  // Short day-of-week from ISO date (UTC to avoid TZ rollovers)
  function dowShortFromISO(iso){
    // Force UTC midnight so local TZ doesn't shift the date
    const d = new Date(iso + 'T00:00:00Z');
    return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getUTCDay()];
  }

  // Build the bullet list HTML for the confirm dialog
  function buildDaysBulletsHTML(dates){
    const items = dates.map(iso=>{
      const list  = state.days[iso] || [];
      const names = list.length
        ? list.map(w => escHtml(w.name || 'Untitled')).join(' · ')
        : '<span class="text-slate-400">(no workouts)</span>';
      const label = `${dowShortFromISO(iso)} — ${iso}`;
      return `<li><b>${label}</b>: ${names}</li>`;
    }).join('');
    return `<ul class="list-disc pl-6 space-y-1">${items}</ul>`;
  }

  function uploadDayCheckboxEls(){ return Array.from(document.querySelectorAll('[data-upday]')); }
  function setUploadDaysAll(val){ uploadDayCheckboxEls().forEach(cb => cb.checked = !!val); }

  function selectedUploadDates(){
    if(!state.weekStart) return [];
    const base = new Date(state.weekStart);
    const idxs = uploadDayCheckboxEls().filter(cb => cb.checked).map(cb => parseInt(cb.getAttribute('data-upday'),10));
    return idxs.map(i => toISODate(addDays(base, i)));
  }

  function countFilteredWorkouts(dates){
    const set = new Set(dates);
    let n = 0;
    Object.entries(state.days).forEach(([iso, list]) => { if(set.has(iso)) n += (list||[]).length; });
    return n;
  }

  // REPLACE your existing buildPayloadFiltered with this:
  function buildPayloadFiltered(dates){
    const set = new Set(dates || []);
    const out = {
      version: 1,
      tz: state.tz,
      athlete_id: Number(state.athleteId || 0),
      week_start: state.weekStart,
      workouts: []
    };
    Object.entries(state.days).forEach(([iso, list])=>{
      if(!set.has(iso)) return;
      (list || []).forEach(w=>{
        const wo = {
          date: iso,
          name: w.name || '',
          type: w.type || 'Ride',
          indoor: !!w.indoor,
          duration_sec: Number(w.duration_sec || 0),
          tss: Number(w.tss || 0),
          notes: w.notes || ''
        };
        if (w.design && typeof w.design === 'object' && Object.keys(w.design).length) {
          wo.design = w.design;
        }
        out.workouts.push(wo);
      });
    });
    return out;
  }


  function updateUploadHint(){
    if(!state.weekStart){ $('#uploadHint').textContent = 'Pick a week on the Plan tab.'; return; }
    const dates = selectedUploadDates();
    const nDays = dates.length;
    const nWos = buildPayloadFiltered(dates).workouts.length;

    $('#uploadHint').innerHTML = nDays
      ? `Selected <b>${nDays}</b> day(s), <b>${nWos}</b> workout(s): ${dates.join(', ')}`
      : `No days selected.`;

    // Update button label + disabled state
    const btn = document.getElementById('uploadIntervalsBtn');
    btn.textContent = nWos ? `Upload to Intervals (${nWos})` : 'Upload to Intervals';
    btn.disabled = nWos === 0;
    btn.classList.toggle('opacity-50', nWos === 0);
    btn.classList.toggle('cursor-not-allowed', nWos === 0);

  }


  // ---------- State ----------
  const state={weekStart:null,tz:'America/Los_Angeles',athleteId:0,days:{}, selectedDay:0};
  const storageKey=()=>`planner:${state.weekStart}`;
  const save=()=>{if(!state.weekStart)return; localStorage.setItem(storageKey(), JSON.stringify(state));};
  const loadWeek=week=>{const raw=localStorage.getItem(`planner:${week}`); try{return raw?JSON.parse(raw):null}catch(_){return null}};

  // ---------- Templates ----------
  const TEMPLATES={
    "Base":{"Build":{"Base-1 (endurance focus)":{
      desc:"Mostly Z2 endurance with light tempo. Long ride Sat.",
      days:{0:[{name:"Rest or 45' Recovery",type:"Ride",indoor:false,duration_sec:2700,tss:20,notes:"Optional spin"}],
            1:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}],
            2:[{name:"Tempo 2x20' @85%",type:"Virtual Ride",indoor:true,duration_sec:4800,tss:70}],
            3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:40}],
            4:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}],
            5:[{name:"Long Endurance Z2 - 3h",type:"Ride",indoor:false,duration_sec:10800,tss:135}],
            6:[{name:"Endurance Z2 - 2h",type:"Ride",indoor:false,duration_sec:7200,tss:90}]}}},
      "Recovery":{"Recovery-Base":{
        desc:"Reduced volume, no intensity.",
        days:{0:[],1:[{name:"Recovery Spin - 45m",type:"Virtual Ride",indoor:true,duration_sec:2700,tss:20}],2:[],
              3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],
              4:[],5:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}],6:[]}}}
    },
    "Build":{"Build":{"Threshold-1":{
      desc:"Threshold focus: 3x12' and 4x8'.",
      days:{0:[],1:[{name:"Threshold 3x12' @95%",type:"Virtual Ride",indoor:true,duration_sec:5400,tss:80}],
            2:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:40}],
            3:[{name:"Threshold 4x8' @100%",type:"Virtual Ride",indoor:true,duration_sec:4800,tss:80}],
            4:[],5:[{name:"Sweet Spot 3x20' @88%",type:"Ride",indoor:false,duration_sec:7200,tss:110}],
            6:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}]}}},
      "Recovery":{"Recovery-Build":{
        desc:"Keep legs spinning; minimal intensity.",
        days:{0:[],1:[{name:"Recovery Spin - 45m",type:"Virtual Ride",indoor:true,duration_sec:2700,tss:20}],2:[],
              3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],
              4:[],5:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:55}],6:[]}}}
    },
    "Specialty":{"Build":{"VO2/Anaerobic-1":{
      desc:"VO2Max + Anaerobic focus.",
      days:{0:[],1:[{name:"VO2Max 5x3' @120%",type:"Virtual Ride",indoor:true,duration_sec:4200,tss:75}],
            2:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:40}],
            3:[{name:"VO2Max 6x2' @125%",type:"Virtual Ride",indoor:true,duration_sec:3600,tss:70}],
            4:[],5:[{name:"Anaerobic 8x1' @150%",type:"Virtual Ride",indoor:true,duration_sec:3600,tss:65}],
            6:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}]}}},
      "Recovery":{"Recovery-Specialty":{
        desc:"Strip intensity, keep short endurance.",
        days:{0:[],1:[{name:"Recovery Spin - 45m",type:"Virtual Ride",indoor:true,duration_sec:2700,tss:20}],2:[],
              3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],
              4:[],5:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],6:[]}}}
    }
  };

  // ---------- Tabs ----------
  const tabs=['plan','loadsave','upload','settings'];
  function setTab(id){
    tabs.forEach(t=>{
      const btn=document.querySelector(`[role="tab"][data-tab="${t}"]`);
      const panel=document.getElementById(`tab-${t}`);
      const sel=(t===id);
      btn.setAttribute('aria-selected', String(sel));
      panel.classList.toggle('hidden', !sel);
    });
  }

  // ---------- GitHub helpers (hardened & public fallback) ----------
  const GH_STORE_KEY='planner:ghcfg';
  const ghLoad=()=>{try{return JSON.parse(localStorage.getItem(GH_STORE_KEY)||'{}')}catch(_){return{}}};
  const ghSaveCfg=cfg=>localStorage.setItem(GH_STORE_KEY, JSON.stringify(cfg||{}));
  function cleanToken(t){ return (t||'').replace(/[\u2000-\u200B\u202F\u205F\uFEFF]/g,'').trim(); }
  function ghGetCfg(){
    const saved=ghLoad();
    return {
      token: ($('#ghToken')?.value) || saved.token || "",
      owner: ($('#ghOwner')?.value) || saved.owner || "tomeese",
      repo:  ($('#ghRepo') ?.value) || saved.repo  || "intervals-icu-bulk-uploader-planned-workouts",
      branch:($('#ghBranch')?.value) || saved.branch|| "main",
      prefix:($('#ghPrefix')?.value) || saved.prefix|| "plans"
    };
  }
  async function ghFetch(url, token, init){
    const tok = cleanToken(token||'');
    const headers = Object.assign({Accept:"application/vnd.github+json"}, tok?{Authorization:'token '+tok}:{});
    const req = Object.assign({headers}, init||{});
    try { return await fetch(url, req); }
    catch (e) {
      if (tok) return await fetch(url, Object.assign({headers:{Accept:"application/vnd.github+json"}}, init||{}));
      throw e;
    }
  }
  async function githubPutFile(cfg, path, text, message){
    const api=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodePathPreserveSlashes(path)}`;
    const getRes=await ghFetch(`${api}?ref=${encodeURIComponent(cfg.branch)}`, cfg.token);
    let sha=null;
    if(getRes.status===200){ sha=(await getRes.json()).sha; }
    else if(getRes.status!==404){ throw new Error(`GET ${getRes.status}: ${await getRes.text()}`); }
    const body={message:message||`save ${path}`,content:base64EncodeUTF8(text),branch:cfg.branch,sha,
      committer:{name:"planner-bot",email:"planner@users.noreply.github.com"},
      author:{name:"planner-bot",email:"planner@users.noreply.github.com"}};
    const putRes=await ghFetch(api, cfg.token, {method:'PUT',body:JSON.stringify(body)});
    const txt=await putRes.text(); if(!putRes.ok) throw new Error(`PUT ${putRes.status}: ${txt.slice(0,400)}`); return JSON.parse(txt);
  }
  async function ghDispatchWorkflow(cfg, workflowFile, inputs){
    const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/actions/workflows/${encodeURIComponent(workflowFile)}/dispatches`;
    const res=await ghFetch(url, cfg.token, {method:"POST",body:JSON.stringify({ref:cfg.branch,inputs:inputs||{}})});
    if(!res.ok) throw new Error(`dispatch ${res.status}: ${await res.text()}`);
    return true;
  }
  async function ghListPlans(cfg, prefix="plans"){
    const p=(prefix||"plans").replace(/^\/+|\/+$/g,"");
    const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodePathPreserveSlashes(p)}?ref=${encodeURIComponent(cfg.branch)}`;
    const res=await ghFetch(url, cfg.token);
    if(!res.ok){ throw new Error(`list ${res.status}: ${await res.text()}`); }
    const items=await res.json();
    return (Array.isArray(items)?items:[])
      .filter(it=>it.type==="file" && /^plan-\d{4}-\d{2}-\d{2}\.json$/.test(it.name))
      .map(it=>({name:it.name,path:it.path}));
  }
  async function ghGetJsonFile(cfg, path){
    const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodePathPreserveSlashes(path)}?ref=${encodeURIComponent(cfg.branch)}`;
    const res=await ghFetch(url, cfg.token);
    if(!res.ok) throw new Error(`get ${res.status}: ${await res.text()}`);
    const obj=await res.json(); const txt=atob((obj.content||"").replace(/\n/g,'')); return JSON.parse(txt);
  }

  // ---------- Template handling ----------
  function updateTemplateList(){
    try{
      const phase=$('#phase').value, focus=$('#focus').value;
      const group=(TEMPLATES[phase]&&TEMPLATES[phase][focus])?TEMPLATES[phase][focus]:{};
      const sel=$('#templateKey'), desc=$('#templateDesc');
      sel.innerHTML='';
      const keys=Object.keys(group);
      if(keys.length){
        keys.forEach(k=>{const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o);});
        sel.value=keys[0]; desc.textContent=group[keys[0]].desc||'';
      }else{
        sel.innerHTML='<option value="">— no templates —</option>'; desc.textContent='No templates for this selection.';
      }
    }catch(e){ showErr(e.message||e); }
  }
  function applyTemplate(){
    const phase=$('#phase').value, focus=$('#focus').value, key=$('#templateKey').value;
    const g=TEMPLATES[phase]&&TEMPLATES[phase][focus]?TEMPLATES[phase][focus]:null;
    const tpl=g&&g[key]; if(!tpl){ alert('No template for selection'); return; }
    if(!state.weekStart){ alert('Pick a week start first.'); return; }
    const base=new Date(state.weekStart); state.days={};
    Object.entries(tpl.days).forEach(([idx,lst])=>{
      const iso=toISODate(addDays(base,parseInt(idx,10)));
      state.days[iso]=(lst||[]).map(w=>({...w}));
    });
    save(); renderDayEditor();
    totals();

    updateUploadHint();
  }

  // ---------- Day editor (tab) ----------
  function currentIso(){ const base=new Date(state.weekStart); return toISODate(addDays(base,state.selectedDay)); }
  function renderDayEditor(){
    const container=$('#dayEditor'); container.innerHTML='';
    if(!state.weekStart) return;
    const iso=currentIso();
    // header
    const hdr=document.createElement('div');
    hdr.className="mb-3 text-sm text-slate-500";
    hdr.textContent=`${dayNames[state.selectedDay]} — ${iso}`;
    container.appendChild(hdr);

    // rows
    const list=state.days[iso]||[];
    list.forEach(w=>container.appendChild(renderRow(iso,w)));
    if(list.length===0){
      const empty=document.createElement('div');
      empty.className="text-sm text-slate-500";
      empty.textContent="No workouts yet. Click 'Add workout'.";
      container.appendChild(empty);
    }
  }

  // ---------- Render a workout row ----------
  function renderRow(iso,w){
    const frag=document.importNode($('#rowTpl').content,true);
    const el=frag.firstElementChild;
    const $name=el.querySelector('[data-name]'), $type=el.querySelector('[data-type]'), $ind=el.querySelector('[data-indoor]');
    const $dur=el.querySelector('[data-duration]'), $tss=el.querySelector('[data-tss]'), $notes=el.querySelector('[data-notes]');
    const $designBtn=el.querySelector('[data-design-btn]'), $panel=el.querySelector('[data-design-panel]');
    const $zwo=el.querySelector('[data-zwo]'), $del=el.querySelector('[data-del]');
    const $d_ftp=el.querySelector('[data-d-ftp]'), $d_sets=el.querySelector('[data-d-sets]'), $d_work=el.querySelector('[data-d-work]');
    const $d_rec=el.querySelector('[data-d-rec]'), $d_target=el.querySelector('[data-d-target]'), $d_ou=el.querySelector('[data-d-ou]');
    const $d_under=el.querySelector('[data-d-under]'), $d_over=el.querySelector('[data-d-over]');
    const $d_warm=el.querySelector('[data-d-warm]'), $d_cool=el.querySelector('[data-d-cool]'), $d_cad=el.querySelector('[data-d-cad]'), $d_erg=el.querySelector('[data-d-erg]');

    // bind
    $name.value=w.name||''; $type.value=w.type||'Ride'; $ind.checked=!!w.indoor;
    $dur.value=hhmmFromSec(w.duration_sec||0); $tss.value=Number.isFinite(w.tss)?w.tss:0; $notes.value=w.notes||'';
    $name.addEventListener('input',()=>{w.name=$name.value; save();}); 
    $type.addEventListener('change',()=>{w.type=$type.value; save(); totals();});
    $ind.addEventListener('change',()=>{w.indoor=$ind.checked; save();});
    $dur.addEventListener('change',()=>{w.duration_sec=parseHHMM($dur.value); $dur.value=normalizeHHMM($dur.value); save(); totals();});
    $tss.addEventListener('change',()=>{w.tss=Math.max(0,parseFloat($tss.value||'0')); save(); totals();});
    $notes.addEventListener('input',()=>{w.notes=$notes.value; save();});

    const d=w.design||{};
    $d_ftp.value=d.ftp_watts??''; $d_sets.value=d.sets??3; $d_work.value=d.work_sec??720; $d_rec.value=d.rec_sec??300;
    $d_target.value=d.target_pct ?? defaultTargetPctByName(w.name||''); $d_ou.checked=!!d.overunder;
    $d_under.value=d.under_pct??''; $d_over.value=d.over_pct??'';
    $d_warm.value=d.warmup_sec??600; $d_cool.value=d.cooldown_sec??600; $d_cad.value=d.cadence??''; $d_erg.checked=(d.erg??true);

    const toggle=show=>$panel.classList.toggle('hidden', !show);
    $designBtn.addEventListener('click',()=>{ toggle($panel.classList.contains('hidden')); });
    el.querySelector('[data-design-cancel]').addEventListener('click',()=>toggle(false));
    el.querySelector('[data-design-save]').addEventListener('click',()=>{
      const obj={
        kind:(/sweet\s*spot/i.test($name.value||""))?"sweetspot":(/threshold/i.test($name.value||""))?"threshold":(/vo2/i.test($name.value||""))?"vo2":(/anaerobic|sprint/i.test($name.value||""))?"anaerobic":"custom",
        ftp_watts:numOrNull($d_ftp.value), sets:numOrNull($d_sets.value)??3, work_sec:numOrNull($d_work.value)??720, rec_sec:numOrNull($d_rec.value)??300,
        target_pct:numOrNull($d_target.value)??defaultTargetPctByName($name.value||""), overunder:$d_ou.checked,
        under_pct:numOrNull($d_under.value)||undefined, over_pct:numOrNull($d_over.value)||undefined,
        warmup_sec:numOrNull($d_warm.value)||600, cooldown_sec:numOrNull($d_cool.value)||600, cadence:numOrNull($d_cad.value)||undefined, erg:!!$d_erg.checked
      };
      for(const k of Object.keys(obj)) if(obj[k]===null) delete obj[k];
      w.design=obj; save(); toggle(false);
    });

    $zwo.addEventListener('click',()=>{
      try{
        if(!w.indoor && !confirm("Not marked Indoor. Generate ZWO anyway?")) return;
        if(/endurance\s*z?2/i.test(w.name||"")){ alert("Skipping Z2 endurance for ZWO."); return; }
        const xml=makeZwoXml(w);
        const safe=safeFilename(`${iso} - ${w.name||'Workout'}`).replace(/\.zwo$/i,'')+'.zwo';
        const cfg=ghGetCfg();
        if(cfg.token && confirm("Upload .zwo to your repo? (Cancel = download only)")){
          const path=`zwo/${safe}`; githubPutFile(cfg,path,xml,`feat(zwo): ${safe}`).then(()=>toast(`Uploaded ${path}`,'ok')).catch(e=>toast(`Upload failed: ${e.message||e}`,'err'));
        }else{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([xml],{type:'application/xml'})); a.download=safe; a.click(); URL.revokeObjectURL(a.href); }
      }catch(e){ alert(`ZWO generation failed: ${e.message||e}`); }
    });

    $del.addEventListener('click',()=>{
      const list=state.days[iso]||[]; const idx=list.indexOf(w);
      if(idx>=0){ list.splice(idx,1); el.remove(); totals(); save(); }
    });

    return frag;
  }

  // ---------- Totals ----------
  function totals(){
    let sec=0,tss=0; const byType=new Map();
    Object.values(state.days).forEach(list=>{
      list.forEach(w=>{ sec+=(w.duration_sec||0); tss+=(w.tss||0);
        const k=w.type||'Ride'; const cur=byType.get(k)||{sec:0,tss:0}; cur.sec+=(w.duration_sec||0); cur.tss+=(w.tss||0); byType.set(k,cur); });
    });
    $('#totPlannedTime').textContent=fmtHMS(sec);
    $('#totPlannedTss').textContent=Math.round(tss);
    $('#totByType').innerHTML=byType.size?Array.from(byType.entries()).map(([k,v])=>`<div><span class="font-medium">${k}</span>: ${fmtHMS(v.sec)}, TSS ${Math.round(v.tss)}</div>`).join(''):'—';
  }

  // ---------- Export / Import / Load ----------
  function buildPayload(){
    const out={version:1,tz:state.tz,athlete_id:Number(state.athleteId||0),week_start:state.weekStart,workouts:[]};
    Object.entries(state.days).forEach(([date,list])=>{
      list.forEach(w=>{
        const wo={date,name:w.name||'',type:w.type||'Ride',indoor:!!w.indoor,duration_sec:Number(w.duration_sec||0),tss:Number(w.tss||0),notes:w.notes||''};
        if(w.design && typeof w.design==='object' && Object.keys(w.design).length) wo.design=w.design;
        out.workouts.push(wo);
      });
    });
    return out;
  }
  function exportJson(){ if(!state.weekStart){ alert('Choose a week start first.'); return; }
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(buildPayload(),null,2)],{type:'application/json'})); a.download=`plan-${state.weekStart}.json`; a.click(); URL.revokeObjectURL(a.href); }
  async function importJson(file){
    if(!file) return; const text=await file.text(); let data;
    try{ data=JSON.parse(text); }catch{ alert('Invalid JSON'); return; }
    if(!data || !data.week_start || !Array.isArray(data.workouts)){ alert('Missing fields'); return;}
    applyPlanData(data);
  }
  function applyPlanData(data){
    state.weekStart=data.week_start; $('#weekStart').value=state.weekStart;
    state.tz=data.tz||state.tz; $('#tz').value=state.tz;
    state.athleteId=(data.athlete_id ?? state.athleteId); $('#athleteId').value=state.athleteId;
    state.days={}; data.workouts.forEach(w=>{ (state.days[w.date] ||= []).push({name:w.name||'',type:w.type||'Ride',indoor:!!w.indoor,duration_sec:Number(w.duration_sec||0),tss:Number(w.tss||0),notes:w.notes||'',design:(w.design&&typeof w.design==='object')?w.design:undefined}); });
    save(); renderDayEditor(); totals();

    updateUploadHint();
  }

  async function refreshPlanList(){
    const msg=$('#loadPlanMsg'); if(msg) msg.textContent='Loading…';
    try{
      const cfg=ghGetCfg(); cfg.token=cleanToken(cfg.token||'');
      const prefix=(cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
      const items=await ghListPlans(cfg,prefix);
      const sel=$('#loadPlanSelect'); if(!sel) return;
      sel.innerHTML='<option value="">— select plan —</option>';
      items.sort((a,b)=>b.name.localeCompare(a.name)).forEach(it=>{
        const o=document.createElement('option'); o.value=it.path; o.textContent=it.name.replace(/^plan-/,'').replace(/\.json$/,''); sel.appendChild(o);
      });
      if(msg) msg.textContent=`${items.length} plan(s) in ${prefix}/`;
    }catch(e){ if(msg) msg.textContent=`Error: ${e.message||e}`; showErr(e.message||e); }
  }
  async function loadSelectedPlan(){
    const path=$('#loadPlanSelect').value; if(!path){ alert('Pick a plan first.'); return; }
    try{
      const cfg=ghGetCfg(); const data=await ghGetJsonFile(cfg,path); applyPlanData(data);
      const link=$('#openPlanLink'); if(link) link.href=`https://github.com/${cfg.owner}/${cfg.repo}/blob/${encodeURIComponent(cfg.branch)}/${path}`;
      const msg=$('#loadPlanMsg'); if(msg) msg.textContent=`Loaded ${path}`;
      toast('Plan loaded','ok');
      setTab('plan');
    }catch(e){ alert(`Load failed: ${e.message||e}`); }
  }

  // ---------- Upload to Intervals (with confirm) ----------
  async function saveThenUpload(){
    if(!state.weekStart){ alert('Pick a week start first.'); return; }

    const dates = selectedUploadDates();
    if (dates.length === 0) { alert('Select at least one day.'); return; }

    // build both full and filtered payloads
    const full = buildPayload();
    const part = buildPayloadFiltered(dates);
    const n = part.workouts.length;
    const bullets = buildDaysBulletsHTML(dates);

    const html = `<div class="space-y-2">
      <div>Week: <b>${full.week_start}</b></div>
      <div>Time zone: <code>${escHtml(full.tz)}</code></div>
      <div>Athlete ID: <code>${full.athlete_id}</code></div>
      <div class="mt-2">${bullets}</div>
      <div class="text-rose-600 font-medium">
        This will upload <b>${n}</b> workout(s) for the selected day(s). Continue?
      </div>
    </div>`;
    const ok = await confirmDialog({title:'Upload to Intervals', html});
    if(!ok) return;

    const cfg = ghGetCfg();
    const prefix = (cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');

    // Keep full-week plan up to date
    const fullPath = `${prefix}/plan-${state.weekStart}.json`;
    await githubPutFile(cfg, fullPath, JSON.stringify(full,null,2), `feat(planner): save ${fullPath}`);

    // For partial uploads, write filtered copy under plans/partial/
    let dispatchPath = fullPath;
    if (dates.length !== 7) {
      const short = dates.map(d=>d.slice(8,10)).join('');
      const partialDir = `${prefix}/partial`;
      const partialPath = `${partialDir}/plan-${state.weekStart}-d${short}.json`;
      await githubPutFile(cfg, partialPath, JSON.stringify(part,null,2), `feat(planner): save ${partialPath}`);
      dispatchPath = partialPath;
    }

    await ghDispatchWorkflow(cfg, 'upload-week-plan.yml', {
      plan_path: dispatchPath,
      tz: full.tz || 'America/Los_Angeles',
      athlete_id: String(full.athlete_id || 0),
      default_start: '06:00',
      dry_run: 'false'
    });

    const runsUrl = `https://github.com/${cfg.owner}/${cfg.repo}/actions/workflows/upload-week-plan.yml`;
    toast(`Upload dispatched for ${n} workout(s).`, 'ok', 3500);
    const hint = $('#uploadHint');
    if(hint) hint.innerHTML = `Dispatched ✓ — <a class="underline" target="_blank" href="${runsUrl}">view workflow runs</a>.`;
  }


  // ---------- Minimal ZWO ----------
  function makeZwoXml(w){
    const name=w.name||"Workout";
    if(/endurance\s*z?2/i.test(name)) throw new Error('Endurance Z2 not converted to ZWO.');
    const d=w.design||{}; const warm=d.warmup_sec??600, cool=d.cooldown_sec??600;
    const sets=Math.max(1,parseInt(d.sets??3,10)), work=Math.max(15,parseInt(d.work_sec??720,10)), rec=Math.max(10,parseInt(d.rec_sec??300,10));
    const pct=(d.target_pct!=null?d.target_pct:defaultTargetPctByName(name));
    const steps=[`<Warmup Duration="${warm}" PowerLow="0.5" PowerHigh="0.75"/>`,
                 `<IntervalsT Repeat="${sets}" OnDuration="${work}" OffDuration="${rec}" OnPower="${pct}" OffPower="0.55" Cadence="0"/>`,
                 `<Cooldown Duration="${cool}" PowerLow="0.5" PowerHigh="0.75"/>`];
    const esc=s=>String(s).replace(/[<>&'"]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;'}[c]));
    return `<?xml version="1.0" encoding="UTF-8"?>
<workout_file>
  <author>planner</author>
  <name>${esc(name)}</name>
  <description>Auto-generated from planner</description>
  <sportType>bike</sportType>
  <tags></tags>
  <workout>
    ${steps.join('\n    ')}
  </workout>
</workout_file>`;
  }

  // ---------- Boot ----------
  function setWeekStartFromInput(){
    const raw=$('#weekStart').value; if(!raw) return;
    const iso=toISODate(mondayOf(raw)); $('#weekStart').value=iso; state.weekStart=iso;
    const prev=loadWeek(iso); if(prev){ state.tz=prev.tz||state.tz; $('#tz').value=state.tz; state.athleteId=(prev.athleteId??state.athleteId); $('#athleteId').value=state.athleteId; state.days=prev.days||{}; state.selectedDay=prev.selectedDay||0; }
    else { state.days={}; state.selectedDay=0; }
    save(); renderDayEditor(); totals();
    // Update day tab selection
    document.querySelectorAll('[data-daytab]').forEach(btn=>btn.setAttribute('aria-selected', btn.getAttribute('data-daytab')==state.selectedDay?'true':'false'));
  
    updateUploadHint();
  }

  (function boot(){
    try{
      // Tab wiring
      document.querySelectorAll('[role="tab"]').forEach(btn=>{
        btn.addEventListener('click', ()=> setTab(btn.getAttribute('data-tab')));
      });
      setTab('plan');

      // Day tab events
      document.querySelectorAll('[data-daytab]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx=parseInt(btn.getAttribute('data-daytab'),10);
          state.selectedDay=idx; document.querySelectorAll('[data-daytab]').forEach(b=>b.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          renderDayEditor();
        });
      });
      $('#addRowBtn').addEventListener('click', ()=>{
        if(!state.weekStart){ alert('Pick a week start first.'); return; }
        const iso=currentIso();
        const w={name:'',type:'Ride',indoor:false,duration_sec:3600,tss:50,notes:''};
        (state.days[iso] ||= []).push(w);
        renderDayEditor(); totals(); save();
      });
      $('#clearDayBtn').addEventListener('click', ()=>{
        if(!state.weekStart) return;
        const iso=currentIso(); state.days[iso]=[]; renderDayEditor(); totals(); save();
      });
      $('#copyPrevDayBtn').addEventListener('click', ()=>{
        if(!state.weekStart || state.selectedDay===0) return;
        const base=new Date(state.weekStart);
        const prevIso=toISODate(addDays(base, state.selectedDay-1));
        const iso=currentIso();
        state.days[iso]=(state.days[prevIso]||[]).map(w=>({...w}));
        renderDayEditor(); totals(); save();
      });

      // Week controls
      $('#weekStart').addEventListener('change', setWeekStartFromInput);
      $('#tz').addEventListener('change',()=>{ state.tz=$('#tz').value; save(); });
      $('#athleteId').addEventListener('change',()=>{ state.athleteId=Number($('#athleteId').value||0); save(); });
      $('#newWeekBtn').addEventListener('click',()=>{ if(!$('#weekStart').value){ alert('Pick a Monday to start.'); return; } state.days={}; save(); renderDayEditor(); totals(); });

      // Template controls
      $('#phase').addEventListener('change', updateTemplateList);
      $('#focus').addEventListener('change', updateTemplateList);
      $('#templateKey').addEventListener('change', ()=>{
        const phase=$('#phase').value, focus=$('#focus').value, key=$('#templateKey').value;
        const g=TEMPLATES[phase]&&TEMPLATES[phase][focus]?TEMPLATES[phase][focus]:null;
        $('#templateDesc').textContent=(g&&g[key]&&g[key].desc)?g[key].desc:'';
      });
      $('#loadTemplateBtn').addEventListener('click', applyTemplate);

      // Load & Save tab
      $('#exportBtn').addEventListener('click', exportJson);
      $('#importFile').addEventListener('change', e=>importJson(e.target.files[0]));
      $('#saveRepoBtn').addEventListener('click', async ()=>{
        if(!state.weekStart){ alert('Pick a week start first.'); return; }
        const cfg=ghGetCfg(); const prefix=(cfg.prefix||'plans').replace(/^\/+|\/+$/g,''); const path=`${prefix}/plan-${state.weekStart}.json`;
        const n=buildPayload().workouts.length;
        const ok=await confirmDialog({title:'Save to repo', html:`Save <b>${path}</b> with <b>${n}</b> workout(s)?`});
        if(!ok) return;
        await githubPutFile(cfg, path, JSON.stringify(buildPayload(),null,2), `feat(planner): save ${path}`);
        toast(`Saved ${path}`,'ok');
      });
      $('#refreshPlansBtn').addEventListener('click', refreshPlanList);
      $('#loadPlanBtn').addEventListener('click', loadSelectedPlan);
      $('#testGhBtn').addEventListener('click', async ()=>{
        try{
          const cfg=ghGetCfg(); const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
          const res=await ghFetch(url, cfg.token);
          const ok=res.ok; const js=await res.json();
          $('#loadPlanMsg').textContent= ok ? `GitHub OK: default_branch=${js.default_branch}` : `GitHub ERROR ${res.status}`;
          toast(ok?'GitHub OK':'GitHub error','ok');
        }catch(e){ $('#loadPlanMsg').textContent=`GitHub ERROR: ${e.message||e}`; toast('GitHub error','err'); }
      });

      // Upload tab
      $('#uploadIntervalsBtn').addEventListener('click', saveThenUpload);

      // Settings tab
      $('#saveGhCfg').addEventListener('click', ()=>{
        const cfg={token:cleanToken($('#ghToken').value),owner:$('#ghOwner').value,repo:$('#ghRepo').value,branch:$('#ghBranch').value,prefix:$('#ghPrefix').value};
        ghSaveCfg(cfg); $('#ghToken').value=cfg.token; $('#saveGhMsg').textContent='Saved ✓'; setTimeout(()=>$('#saveGhMsg').textContent='',2500);
        toast('GitHub settings saved','ok');
      });
      $('#clearGhCfg').addEventListener('click', ()=>{ localStorage.removeItem(GH_STORE_KEY); if($('#ghToken')) $('#ghToken').value=''; $('#saveGhMsg').textContent='Cleared'; setTimeout(()=>$('#saveGhMsg').textContent='',2000); toast('GitHub token cleared','warn'); });

      // Boot defaults
      const isoMonday=toISODate(mondayOf(new Date())); $('#weekStart').value=isoMonday; setWeekStartFromInput();
      updateTemplateList();
      refreshPlanList(); // public fallback works if repo is public

      // Upload day selection events
      document.getElementById('upSelectAll').addEventListener('change', e => { setUploadDaysAll(e.target.checked); updateUploadHint(); });
      uploadDayCheckboxEls().forEach(cb => cb.addEventListener('change', () => {
        // Keep "select all" in sync
        const allChecked = uploadDayCheckboxEls().every(x => x.checked);
        document.getElementById('upSelectAll').checked = allChecked;
        updateUploadHint();
      }));

      document.getElementById('upWeekdays').addEventListener('click', ()=>{
      uploadDayCheckboxEls().forEach((cb,i)=> cb.checked = (i>=0 && i<=4)); // Mon–Fri
      document.getElementById('upSelectAll').checked = false;
      updateUploadHint();
      });
      document.getElementById('upWeekend').addEventListener('click', ()=>{
        uploadDayCheckboxEls().forEach((cb,i)=> cb.checked = (i===5 || i===6)); // Sat/Sun
        document.getElementById('upSelectAll').checked = false;
        updateUploadHint();
      });

      updateUploadHint();


    }catch(e){ showErr(e.message||e); }
  })();
  </script>
</body>
</html>
