<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weekly Workout Planner</title>
  <meta name="color-scheme" content="light dark"/>

  <!-- Prebuilt Tailwind v4 stylesheet (built by GH Action) -->
  <link rel="stylesheet" href="assets/tw.css?v=3"/>

  <!-- Favicon (project page path) -->
  <link rel="icon" href="./favicon.ico" sizes="any">

  <style>
    /* Safety: even if Tailwind fails to load, don't fall back to Times */
    html{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}

    /* ---------- Tokens ---------- */
    :root{
      /* Panel + tabs (light) */
      --panelBg: #fff;
      --tabBorder: rgb(203 213 225);      /* slate-300 */
      --tabInactiveBg: rgb(248 250 252);  /* slate-50 */
      --tabInactiveFg: rgb(71 85 105);    /* slate-600 */
      --tabActiveAccent: rgb(37 99 235);  /* blue-600 */
      --tabActiveText:   rgb(100 124 201);/* preferred accent text */

      /* Inputs (light) */
      --inputBg: #fff;
      --inputFg: rgb(15 23 42);           /* slate-900 */
      --inputBd: rgb(226 232 240);        /* slate-200 */

      /* Buttons (light) */
      --btnPrimaryBg: rgb(37 99 235);     /* blue-600 */
      --btnDangerBg:  rgb(220 38 38);     /* red-600  */
      --btnSecBg:     rgb(226 232 240);   /* slate-200 */
      --btnSecFg:     rgb(15 23 42);      /* slate-900 */
      --btnSecBd:     rgb(203 213 225);   /* slate-300 */
      --btnOlFg:      rgb(51 65 85);      /* slate-700 */
      --btnOlBd:      rgb(203 213 225);   /* slate-300 */
    }
    @media (prefers-color-scheme: dark){
      :root{
        --panelBg: rgb(30 41 59);         /* slate-800 */
        --tabBorder: rgb(51 65 85);       /* slate-700 */
        --tabInactiveBg: rgb(30 41 59);   /* slate-800 */
        --tabInactiveFg: rgb(203 213 225);/* slate-300 */
        --tabActiveAccent: rgb(96 165 250); /* blue-400 */
        --tabActiveText:   rgb(100 124 201); /* user preference */

        --inputBg: rgb(15 23 42);         /* slate-900 */
        --inputFg: rgb(226 232 240);      /* slate-200/300 */
        --inputBd: rgb(51 65 85);         /* slate-700 */

        --btnSecBg:  rgb(30 41 59);       /* slate-800 */
        --btnSecFg:  rgb(203 213 225);    /* slate-300 */
        --btnSecBd:  rgb(51 65 85);       /* slate-700 */
        --btnOlFg:   rgb(203 213 225);    /* slate-300 */
        --btnOlBd:   rgb(51 65 85);       /* slate-700 */
      }
    }

    /* ---------- Utilities ---------- */
    [hidden]{display:none !important;}
    .card{border-radius:.75rem}
    .field{display:flex;flex-direction:column;gap:.45rem}

    /* ---------- Button system ---------- */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:.55rem .9rem; border-radius:.6rem; font-weight:600;
      border:1px solid var(--btnSecBd); transition:filter .15s ease,opacity .15s;
    }
    .btn:hover{ filter:brightness(0.97); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-primary{ background:var(--btnPrimaryBg); color:#fff; border-color:var(--btnPrimaryBg); }
    .btn-secondary{ background:var(--btnSecBg); color:var(--btnSecFg); border-color:var(--btnSecBd); }
    .btn-outline{ background:transparent; color:var(--btnOlFg); border-color:var(--btnOlBd); }
    .btn-danger{ background:var(--btnDangerBg); color:#fff; border-color:var(--btnDangerBg); }
    /* Dark-mode contrast for outline buttons */
    @media (prefers-color-scheme: dark){
      .btn-outline{
        background: rgba(148, 163, 184, 0.10) !important; /* slate-400 @10% */
        color: rgb(226, 232, 240) !important;              /* slate-200 */
        border-color: rgb(71, 85, 105) !important;         /* slate-600 */
      }
      .btn-outline:hover{
        background: rgba(148, 163, 184, 0.18) !important;
        border-color: rgb(100, 116, 139) !important;
        filter: none;
      }
    }

    /* ---------- Top nav tabs ---------- */
    .tabs{
      display:flex; gap:.4rem; align-items:flex-end;
      border-bottom:1px solid var(--tabBorder);
      overflow-x:auto; -webkit-overflow-scrolling:touch;
      padding:0 .25rem;
    }
    .tabs::-webkit-scrollbar{ height:6px }
    .tabs::-webkit-scrollbar-thumb{ background:rgba(100,116,139,.35); border-radius:9999px }
    .tab{
      position:relative; top:1px;
      padding:.55rem .9rem; font-weight:600;
      border:1px solid var(--tabBorder); border-bottom:none;
      border-top-left-radius:.6rem; border-top-right-radius:.6rem;
      background:var(--tabInactiveBg); color:var(--tabInactiveFg);
      transition: filter .15s ease, background .15s ease, color .15s ease;
      white-space:nowrap;
    }
    .tab:hover{ filter:brightness(.98) }
    .tab[aria-selected="true"]{
      background: var(--panelBg) !important;
      color: var(--tabActiveText) !important;
      font-weight: 700;
      border-color: var(--tabBorder) !important;
      border-top: 3px solid var(--tabActiveAccent) !important;
      padding-top: calc(.55rem - 2px);
      z-index:2;
      box-shadow: 0 1px 0 0 var(--panelBg);
    }
    .tabpanel{
      background:var(--panelBg);
      border:1px solid var(--tabBorder);
      border-top:none;
      border-bottom-left-radius:.75rem; border-bottom-right-radius:.75rem;
    }

    /* ---------- Day tabs styled like top tabs ---------- */
    .day-tabs{
      display:flex; gap:.4rem; align-items:flex-end;
      border-bottom:1px solid var(--tabBorder);
      overflow-x:auto; -webkit-overflow-scrolling:touch;
      padding:0 .25rem; margin-top:.5rem;
    }
    .day-tabs::-webkit-scrollbar{ height:6px }
    .day-tabs::-webkit-scrollbar-thumb{ background:rgba(100,116,139,.35); border-radius:9999px }
    .day-tab{
      position:relative; top:1px;
      padding:.5rem .8rem; font-weight:600;
      border:1px solid var(--tabBorder); border-bottom:none;
      border-top-left-radius:.6rem; border-top-right-radius:.6rem;
      background:var(--tabInactiveBg); color:var(--tabInactiveFg);
      transition: filter .15s ease, background .15s ease, color .15s ease;
      white-space:nowrap;
    }
    .day-tab:hover{ filter:brightness(.98) }
    .day-tab[aria-selected="true"]{
      background:var(--panelBg) !important;
      color:var(--tabActiveText) !important;
      font-weight:700;
      border-color:var(--tabBorder) !important;
      border-top:3px solid var(--tabActiveAccent) !important;
      padding-top:calc(.5rem - 2px);
      z-index:2;
    }
    .day-tabpanel{
      background:var(--panelBg);
      border:1px solid var(--tabBorder);
      border-top:none;
      border-bottom-left-radius:.75rem; border-bottom-right-radius:.75rem;
      padding:1rem;
    }
    .tabs .tab{ background: var(--tabInactiveBg) !important; color: var(--tabInactiveFg) !important; border-color: var(--tabBorder) !important; }
    .tabs .tab[aria-selected="true"]{ background: var(--panelBg) !important; color: var(--tabActiveText) !important; border-color: var(--tabBorder) !important; }

    /* Totals as a separate card */
    .totals-card{
      background:var(--panelBg);
      border:1px solid var(--tabBorder);
      border-radius:.75rem;
      padding:1rem;
      margin-top:1rem;
    }

    /* Inputs inside panels: readable in both modes */
    .tabpanel input,
    .tabpanel select,
    .tabpanel textarea{
      background: var(--inputBg) !important;
      color: var(--inputFg) !important;
      border: 1px solid var(--inputBd) !important;
    }
    .tabpanel input::placeholder,
    .tabpanel textarea::placeholder{ color: color-mix(in oklab, var(--inputFg) 55%, transparent); }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <header class="mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Weekly Workout Planner</h1>
      <div class="text-xs text-slate-500">TZ: <span id="tzBadge">America/Los_Angeles</span></div>
    </header>

    <!-- Top tabs -->
    <nav class="tabs mb-0" role="tablist" aria-label="Planner tabs">
      <button class="tab" role="tab" data-tab="plan"      aria-selected="true">Plan</button>
      <button class="tab" role="tab" data-tab="loadsave"  aria-selected="false">Load &amp; Save</button>
      <button class="tab" role="tab" data-tab="upload"    aria-selected="false">Intervals Upload</button>
      <button class="tab" role="tab" data-tab="settings"  aria-selected="false">Settings</button>
    </nav>

    <!-- PLAN -->
    <section id="tab-plan" role="tabpanel" class="tabpanel p-4 space-y-6">
      <!-- plan header / template -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
          <h3 class="text-lg font-semibold mb-3">Week</h3>
          <div class="field">
            <label class="text-xs text-slate-500">Week start (Monday)</label>
            <input id="weekStart" type="date" class="rounded-lg px-2.5 py-1.5"/>
          </div>
          <div class="field mt-2">
            <label class="text-xs text-slate-500">Template</label>
            <select id="templateSelect" class="rounded-lg px-2.5 py-1.5">
              <option value="">— Select —</option>
              <option value="base-build">Base · Build week</option>
              <option value="base-recovery">Base · Recovery week</option>
              <option value="build-threshold">Build · Threshold focus</option>
              <option value="specialty-vo2">Specialty · VO₂Max focus</option>
            </select>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <button id="loadTemplateBtn" class="btn btn-primary">Load template</button>
            <button id="newWeekBtn" class="btn btn-secondary">Clear week</button>
          </div>
        </div>

        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4 md:col-span-2">
          <h3 class="text-lg font-semibold">Edit days</h3>

          <!-- Day tabs header -->
          <div class="p-3">
            <div class="day-tabs" role="tablist" aria-label="Weekdays">
              <button class="day-tab" data-day="0" aria-selected="true">Mon</button>
              <button class="day-tab" data-day="1" aria-selected="false">Tue</button>
              <button class="day-tab" data-day="2" aria-selected="false">Wed</button>
              <button class="day-tab" data-day="3" aria-selected="false">Thu</button>
              <button class="day-tab" data-day="4" aria-selected="false">Fri</button>
              <button class="day-tab" data-day="5" aria-selected="false">Sat</button>
              <button class="day-tab" data-day="6" aria-selected="false">Sun</button>
            </div>
          </div>

          <!-- Connected panel -->
          <div class="day-tabpanel space-y-4">
            <div class="flex items-center gap-2 justify-end">
              <button class="btn btn-outline" id="copyPrevDayBtn">Copy prev</button>
              <button class="btn btn-outline" id="clearDayBtn">Clear day</button>
              <button class="btn btn-primary" id="addRowBtn">Add workout</button>
            </div>
            <div id="dayEditor"><!-- rows render here --></div>
          </div>
        </div>
      </div>

      <!-- Totals (separate card) -->
      <section class="totals-card space-y-4" id="totals">
        <h3 class="text-lg font-semibold">Totals</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
            <div class="text-xs text-slate-500">Planned Time</div>
            <div id="totPlannedTime" class="text-base font-semibold">0h 00m</div>
          </div>
          <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
            <div class="text-xs text-slate-500">Planned TSS</div>
            <div id="totPlannedTss" class="text-base font-semibold">0</div>
          </div>
          <div class="md:col-span-1 col-span-2 p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
            <div class="text-xs text-slate-500 mb-1">By Type</div>
            <div id="totByType" class="text-sm leading-6">—</div>
          </div>
        </div>
      </section>
    </section>

    <!-- LOAD & SAVE -->
    <section id="tab-loadsave" role="tabpanel" class="tabpanel p-4 space-y-6" hidden>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4 space-y-3">
          <h3 class="text-lg font-semibold">Save</h3>
          <div class="text-xs text-slate-500">Saves the current plan JSON to your repo under <code>&lt;prefix&gt;/plan-&lt;week&gt;.json</code>.</div>
          <button id="saveRepoBtn" class="btn btn-primary w-full">Save to repo</button>
          <button id="exportBtn" class="btn btn-secondary w-full">Export JSON</button>
          <div id="saveHint" class="text-xs text-slate-500"></div>
        </div>

        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4 space-y-3">
          <h3 class="text-lg font-semibold">Load from repo</h3>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-end">
            <div class="md:col-span-4">
              <label class="text-xs text-slate-500">Plan file</label>
              <select id="planList" class="w-full rounded-lg px-2.5 py-1.5"></select>
            </div>
            <div class="md:col-span-1 flex gap-2">
              <button id="refreshPlansBtn" class="btn btn-outline w-full">Refresh</button>
            </div>
          </div>
          <div class="flex gap-2">
            <button id="loadPlanBtn" class="btn btn-primary">Load</button>
            <a id="openPlanLink" class="btn btn-outline" target="_blank" href="#">Open on GitHub</a>
          </div>
          <div class="text-xs text-slate-500" id="loadHint"></div>
        </div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section id="tab-upload" role="tabpanel" class="tabpanel p-4 space-y-4" hidden>
      <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
        <h3 class="text-lg font-semibold mb-2">Upload to Intervals</h3>
        <p class="text-sm text-slate-500 mb-4">Select day(s) to upload. We’ll save a filtered plan file and trigger <code>upload-week-plan.yml</code>.</p>

        <!-- Day checkboxes -->
        <div class="mb-3 flex flex-wrap gap-3 items-center">
          <label class="inline-flex items-center gap-2">
            <input id="upSelectAll" type="checkbox" class="h-4 w-4" checked>
            <span>Select all</span>
          </label>
          <div class="flex flex-wrap gap-3">
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="0" checked><span>Mon</span></label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="1" checked><span>Tue</span></label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="2" checked><span>Wed</span></label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="3" checked><span>Thu</span></label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="4" checked><span>Fri</span></label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="5" checked><span>Sat</span></label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" class="h-4 w-4" data-upday="6" checked><span>Sun</span></label>
          </div>
          <div class="ml-auto flex gap-2">
            <button id="upWeekdays" class="btn btn-outline">Weekdays</button>
            <button id="upWeekend"  class="btn btn-outline">Weekend</button>
          </div>
        </div>

        <button id="uploadIntervalsBtn" class="btn btn-primary">Upload to Intervals</button>
        <div class="text-xs text-slate-500 mt-3" id="uploadHint"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" role="tabpanel" class="tabpanel p-4 space-y-6" hidden>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4 space-y-3">
          <h3 class="text-lg font-semibold">GitHub save settings</h3>
          <div class="text-xs text-slate-500">Stored only in this browser. Needs Content: Read &amp; Write.</div>
          <label class="block">
            <span class="block text-xs text-slate-500">Personal Access Token</span>
            <input id="ghToken" type="password" placeholder="ghp_…" class="w-full rounded-lg px-2.5 py-1.5"/>
          </label>
          <div class="grid grid-cols-2 gap-2">
            <label><span class="block text-xs text-slate-500">Owner</span><input id="ghOwner" class="w-full rounded-lg px-2.5 py-1.5"/></label>
            <label><span class="block text-xs text-slate-500">Repo</span><input id="ghRepo" class="w-full rounded-lg px-2.5 py-1.5"/></label>
            <label><span class="block text-xs text-slate-500">Branch</span><input id="ghBranch" value="main" class="w-full rounded-lg px-2.5 py-1.5"/></label>
            <label><span class="block text-xs text-slate-500">Path prefix</span><input id="ghPrefix" value="plans" class="w-full rounded-lg px-2.5 py-1.5"/></label>
          </div>
          <div class="flex gap-2">
            <button id="saveGhCfg" class="btn btn-primary">Save settings</button>
            <button id="clearGhCfg" class="btn btn-danger">Clear token</button>
            <button id="testGhBtn" class="btn btn-outline">Test GitHub</button>
          </div>
          <div id="ghHint" class="text-xs text-slate-500"></div>
        </div>

        <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4 space-y-3">
          <h3 class="text-lg font-semibold">Planner defaults</h3>
          <div class="grid grid-cols-2 gap-2">
            <label><span class="block text-xs text-slate-500">Time zone</span><input id="inpTz" value="America/Los_Angeles" class="w-full rounded-lg px-2.5 py-1.5"/></label>
            <label><span class="block text-xs text-slate-500">Athlete ID</span><input id="inpAthlete" value="0" class="w-full rounded-lg px-2.5 py-1.5"/></label>
          </div>
          <div class="text-xs text-slate-500">These are embedded into saved plan JSON and used by the workflow.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal (confirm) -->
  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative max-w-lg mx-auto mt-24 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4">
      <h3 id="modalTitle" class="text-lg font-semibold mb-2">Confirm</h3>
      <div id="modalBody" class="prose prose-sm dark:prose-invert max-w-none"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="btn btn-outline">Cancel</button>
        <button id="modalOk" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden"></div>

  <script>
    // ---------- State ----------
    const state = {
      tz: 'America/Los_Angeles',
      athleteId: 0,
      weekStart: null,         // ISO Monday
      selectedDay: 0,          // 0..6
      days: {}                 // { 'YYYY-MM-DD': [ {name,type,indoor,duration_sec,tss,notes,design?} ] }
    };

    // ---------- Small utils ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const escHtml = s => String(s ?? '').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const toISO = d => d.toISOString().slice(0,10);
    const today = () => toISO(new Date());
    function mondayOfCurrentWeek(tz='America/Los_Angeles'){
      const now = new Date(); // use local; visually OK for input
      const dow = (now.getDay()+6)%7; // 0=Mon
      const mon = new Date(now); mon.setDate(now.getDate()-dow);
      return toISO(mon);
    }

    // ---------- Top tabs ----------
    function switchTopTab(name){
      $$('[role="tab"][data-tab]').forEach(btn=>{
        btn.setAttribute('aria-selected', btn.dataset.tab === name ? 'true' : 'false');
      });
      $$('section[role="tabpanel"]').forEach(sec=>{
        const key = sec.id.replace(/^tab-/, '');
        sec.hidden = (key !== name);
      });
    }
    function initTopTabs(){
      $$('[role="tab"][data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=> switchTopTab(btn.dataset.tab));
      });
      const current = document.querySelector('[role="tab"][aria-selected="true"][data-tab]');
      switchTopTab(current ? current.dataset.tab : 'plan');
    }

    // ---------- Day tabs ----------
    function isoForDayIndex(idx){
      if (!state.weekStart) return null;
      const d = new Date(state.weekStart + 'T00:00:00');
      d.setDate(d.getDate() + Number(idx || 0));
      return toISO(d);
    }
    function ensureDay(iso){
      if (!state.days[iso]) state.days[iso] = [];
      return state.days[iso];
    }
    function bindDayTabs(){
      $$('.day-tab').forEach(btn=>{
        btn.addEventListener('click', ()=> setSelectedDay(parseInt(btn.dataset.day,10)));
      });
    }
    function setSelectedDay(idx){
      if (idx == null) return;
      state.selectedDay = Number(idx);
      const iso = isoForDayIndex(state.selectedDay);
      if (!iso) return;
      ensureDay(iso);
      $$('.day-tab').forEach((b,i)=> b.setAttribute('aria-selected', i===state.selectedDay ? 'true':'false'));
      renderDay(iso);
      updateTotals();
      updateUploadHint();
    }

    // ---------- Templates (simple seeders) ----------
    const TEMPLATES = {
      'base-build': (startISO)=>({
        'Mon':[{name:'Endurance Z2 - 90m', type:'Ride', indoor:false, duration_sec:5400, tss:60, notes:''}],
        'Tue':[{name:'Tempo 3x12m', type:'Ride', indoor:true,  duration_sec:4500, tss:70, notes:'', design:{target_pct:0.90, sets:3, work_sec:720, rec_sec:300, warmup_sec:600, cooldown_sec:600}}],
        'Wed':[{name:'Endurance Z2 - 75m', type:'Ride', indoor:false, duration_sec:4500, tss:50, notes:''}],
        'Thu':[{name:'Sweet Spot 4x8m', type:'Virtual Ride', indoor:true, duration_sec:4200, tss:72, notes:'', design:{target_pct:0.93, sets:4, work_sec:480, rec_sec:240, warmup_sec:600, cooldown_sec:600}}],
        'Fri':[],
        'Sat':[{name:'Long Endurance - 3h', type:'Gravel Ride', indoor:false, duration_sec:10800, tss:150, notes:''}],
        'Sun':[{name:'Recovery Spin 45m', type:'Virtual Ride', indoor:true, duration_sec:2700, tss:25, notes:''}]
      }),
      'base-recovery': ()=>({
        'Mon':[],
        'Tue':[{name:'Recovery Spin 45m', type:'Virtual Ride', indoor:true, duration_sec:2700, tss:25, notes:''}],
        'Wed':[ ],
        'Thu':[{name:'Endurance Z2 - 60m', type:'Ride', indoor:false, duration_sec:3600, tss:35, notes:''}],
        'Fri':[ ],
        'Sat':[{name:'Endurance Z2 - 90m', type:'Ride', indoor:false, duration_sec:5400, tss:60, notes:''}],
        'Sun':[ ]
      }),
      'build-threshold': ()=>({
        'Mon':[ ],
        'Tue':[ {name:'Threshold 3x12m', type:'Virtual Ride', indoor:true, duration_sec:4500, tss:85, notes:'', design:{target_pct:0.95, sets:3, work_sec:720, rec_sec:300, warmup_sec:600, cooldown_sec:600}}],
        'Wed':[ {name:'Endurance Z2 - 75m', type:'Ride', indoor:false, duration_sec:4500, tss:50, notes:''}],
        'Thu':[ {name:'Over/Under 6x6m', type:'Virtual Ride', indoor:true, duration_sec:4200, tss:90, notes:'', design:{target_pct:1.0, sets:6, work_sec:360, rec_sec:180, warmup_sec:600, cooldown_sec:600}}],
        'Fri':[ ],
        'Sat':[ {name:'Endurance Z2 - 2h', type:'Ride', indoor:false, duration_sec:7200, tss:90, notes:''}],
        'Sun':[ {name:'Endurance Z2 - 90m', type:'Ride', indoor:false, duration_sec:5400, tss:60, notes:''}]
      }),
      'specialty-vo2': ()=>({
        'Mon':[ ],
        'Tue':[ {name:'VO₂Max 5x3m', type:'Virtual Ride', indoor:true, duration_sec:3600, tss:85, notes:'', design:{target_pct:1.20, sets:5, work_sec:180, rec_sec:240, warmup_sec:600, cooldown_sec:600}}],
        'Wed':[ {name:'Recovery Spin 45m', type:'Virtual Ride', indoor:true, duration_sec:2700, tss:25, notes:''}],
        'Thu':[ {name:'VO₂Max 6x2m', type:'Virtual Ride', indoor:true, duration_sec:3000, tss:80, notes:'', design:{target_pct:1.25, sets:6, work_sec:120, rec_sec:180, warmup_sec:600, cooldown_sec:600}}],
        'Fri':[ ],
        'Sat':[ {name:'Endurance Z2 - 2h', type:'Ride', indoor:false, duration_sec:7200, tss:90, notes:''}],
        'Sun':[ ]
      })
    };

    function applyTemplate(key){
      if(!state.weekStart){ alert('Pick a week start first.'); return; }
      const map = TEMPLATES[key]?.();
      if(!map){ toast('Select a template first.','warn'); return; }
      const labelToIdx = {Mon:0,Tue:1,Wed:2,Thu:3,Fri:4,Sat:5,Sun:6};
      for(const [lbl, arr] of Object.entries(map)){
        const iso = isoForDayIndex(labelToIdx[lbl]);
        state.days[iso] = (arr || []).map(x=>({...x}));
      }
      setSelectedDay(state.selectedDay ?? 0);
      updateTotals();
      toast('Template applied.','ok');
    }

    // ---------- Editor ----------
    function hmsFromSec(sec){ sec=Number(sec||0); const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); return {h,m}; }
    function secFromHM(h,m){ return (Number(h||0)*3600 + Number(m||0)*60); }

    function renderDay(iso){
      const list = ensureDay(iso);
      const root = $('#dayEditor');
      root.innerHTML = '';

      // each workout row
      list.forEach((w,idx)=>{
        const {h,m} = hmsFromSec(w.duration_sec);
        const row = document.createElement('div');
        row.className = 'p-3 border border-slate-200 dark:border-slate-800 rounded-lg';
        row.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-6 gap-2 items-end">
            <label class="field md:col-span-2">
              <span class="text-xs text-slate-500">Name</span>
              <input data-k="name" value="${escHtml(w.name||'')}" class="rounded-lg px-2.5 py-1.5"/>
            </label>
            <label class="field">
              <span class="text-xs text-slate-500">Type</span>
              <select data-k="type" class="rounded-lg px-2.5 py-1.5">
                ${['Ride','Gravel Ride','Virtual Ride'].map(t=>`<option ${w.type===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </label>
            <label class="field">
              <span class="text-xs text-slate-500">Indoor</span>
              <select data-k="indoor" class="rounded-lg px-2.5 py-1.5">
                <option value="false" ${!w.indoor?'selected':''}>No</option>
                <option value="true"  ${ w.indoor?'selected':''}>Yes</option>
              </select>
            </label>
            <div class="grid grid-cols-2 gap-2">
              <label class="field">
                <span class="text-xs text-slate-500">Hours</span>
                <input data-k="dur_h" type="number" min="0" value="${h}" class="rounded-lg px-2.5 py-1.5"/>
              </label>
              <label class="field">
                <span class="text-xs text-slate-500">Minutes</span>
                <input data-k="dur_m" type="number" min="0" max="59" value="${m}" class="rounded-lg px-2.5 py-1.5"/>
              </label>
            </div>
            <label class="field">
              <span class="text-xs text-slate-500">TSS</span>
              <input data-k="tss" type="number" min="0" value="${Number(w.tss||0)}" class="rounded-lg px-2.5 py-1.5"/>
            </label>
          </div>
          <div class="mt-2 grid grid-cols-1 gap-2">
            <label class="field">
              <span class="text-xs text-slate-500">Notes</span>
              <textarea data-k="notes" rows="2" class="rounded-lg px-2.5 py-1.5">${escHtml(w.notes||'')}</textarea>
            </label>
          </div>
          <div class="mt-2 flex gap-2 justify-end">
            <button class="btn btn-outline" data-design-btn>Design</button>
            <button class="btn btn-secondary" data-zwo>Generate ZWO</button>
            <button class="btn btn-danger" data-del>Delete</button>
          </div>
          <div class="mt-2 hidden" data-design-panel>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
              <label class="field"><span class="text-xs text-slate-500">Target %FTP</span><input data-d="target_pct" type="number" step="0.01" value="${w.design?.target_pct ?? ''}" class="rounded-lg px-2.5 py-1.5"/></label>
              <label class="field"><span class="text-xs text-slate-500">Sets</span><input data-d="sets" type="number" value="${w.design?.sets ?? ''}" class="rounded-lg px-2.5 py-1.5"/></label>
              <label class="field"><span class="text-xs text-slate-500">Work (sec)</span><input data-d="work_sec" type="number" value="${w.design?.work_sec ?? ''}" class="rounded-lg px-2.5 py-1.5"/></label>
              <label class="field"><span class="text-xs text-slate-500">Recovery (sec)</span><input data-d="rec_sec" type="number" value="${w.design?.rec_sec ?? ''}" class="rounded-lg px-2.5 py-1.5"/></label>
              <label class="field"><span class="text-xs text-slate-500">Warmup (sec)</span><input data-d="warmup_sec" type="number" value="${w.design?.warmup_sec ?? ''}" class="rounded-lg px-2.5 py-1.5"/></label>
              <label class="field"><span class="text-xs text-slate-500">Cooldown (sec)</span><input data-d="cooldown_sec" type="number" value="${w.design?.cooldown_sec ?? ''}" class="rounded-lg px-2.5 py-1.5"/></label>
            </div>
            <div class="mt-2 flex gap-2 justify-end">
              <button class="btn btn-outline" data-design-cancel>Close</button>
              <button class="btn btn-primary" data-design-save>Save</button>
            </div>
          </div>
        `;
        root.appendChild(row);

        // handlers
        row.querySelectorAll('[data-k]').forEach(inp=>{
          inp.addEventListener('input', ()=>{
            const k = inp.getAttribute('data-k');
            if(k==='name') w.name = inp.value;
            else if(k==='type') w.type = inp.value;
            else if(k==='indoor') w.indoor = (inp.value==='true');
            else if(k==='tss') w.tss = Number(inp.value||0);
            else if(k==='dur_h' || k==='dur_m'){
              const hh = Number(row.querySelector('[data-k="dur_h"]').value||0);
              const mm = Number(row.querySelector('[data-k="dur_m"]').value||0);
              w.duration_sec = secFromHM(hh,mm);
            }
            updateTotals();
            updateUploadHint();
          });
        });
        row.querySelector('[data-k="notes"]').addEventListener('input', e=>{ w.notes = e.target.value; });

        row.querySelector('[data-del]').addEventListener('click', ()=>{
          list.splice(idx,1); renderDay(iso); updateTotals(); updateUploadHint();
        });
        row.querySelector('[data-design-btn]').addEventListener('click', ()=>{
          row.querySelector('[data-design-panel]').classList.toggle('hidden');
        });
        row.querySelector('[data-design-cancel]').addEventListener('click', ()=>{
          row.querySelector('[data-design-panel]').classList.add('hidden');
        });
        row.querySelector('[data-design-save]').addEventListener('click', ()=>{
          const d = w.design || (w.design={});
          row.querySelectorAll('[data-d]').forEach(inp=>{
            const k = inp.getAttribute('data-d');
            const v = inp.value;
            d[k] = v==='' ? undefined : Number(v);
          });
          toast('Design saved.','ok',1500);
        });
      });

      // add-row button
      $('#addRowBtn').onclick = ()=>{
        list.push({name:'',type:'Ride',indoor:false,duration_sec:0,tss:0,notes:''});
        renderDay(iso); updateTotals(); updateUploadHint();
      };
      $('#clearDayBtn').onclick = ()=>{
        if(!confirm('Clear all workouts for this day?')) return;
        state.days[iso] = []; renderDay(iso); updateTotals(); updateUploadHint();
      };
      $('#copyPrevDayBtn').onclick = ()=>{
        const prev = isoForDayIndex(state.selectedDay-1);
        if(!prev) return;
        state.days[iso] = (state.days[prev]||[]).map(x=>({...x}));
        renderDay(iso); updateTotals(); updateUploadHint();
      };
    }

    // ---------- Totals ----------
    function updateTotals(){
      let seconds=0, tss=0; const byType = {};
      Object.values(state.days).forEach(list=>{
        (list||[]).forEach(w=>{
          seconds += Number(w.duration_sec||0);
          tss     += Number(w.tss||0);
          const k = w.type || 'Other';
          byType[k] = byType[k] || {sec:0, tss:0};
          byType[k].sec += Number(w.duration_sec||0);
          byType[k].tss += Number(w.tss||0);
        });
      });
      const h = Math.floor(seconds/3600), m = Math.floor((seconds%3600)/60);
      $('#totPlannedTime').textContent = `${h}h ${String(m).padStart(2,'0')}m`;
      $('#totPlannedTss').textContent = Math.round(tss);
      const by = Object.entries(byType).map(([k,v])=>{
        const hh=Math.floor(v.sec/3600), mm=Math.floor((v.sec%3600)/60);
        return `<span class="inline-block mr-3"><b>${escHtml(k)}</b>: ${hh}h ${String(mm).padStart(2,'0')}m, TSS ${Math.round(v.tss)}</span>`;
      }).join(' ');
      $('#totByType').innerHTML = by || '—';
    }

    // ---------- Build + filtered payloads ----------
    function buildPayload(){
      // Flatten days into workouts array
      const workouts = [];
      Object.entries(state.days).forEach(([iso,list])=>{
        (list||[]).forEach(w=>{
          const item = {
            date: iso,
            name: w.name || '',
            type: w.type || 'Ride',
            indoor: !!w.indoor,
            duration_sec: Number(w.duration_sec||0),
            tss: Number(w.tss||0),
            notes: w.notes || ''
          };
          if (w.design && Object.keys(w.design).length) item.design = w.design;
          workouts.push(item);
        });
      });
      return {
        version: 1,
        tz: state.tz,
        athlete_id: Number(state.athleteId||0),
        week_start: state.weekStart,
        workouts
      };
    }
    function uploadDayCheckboxEls(){ return $$('#tab-upload [data-upday]'); }
    function setUploadDaysAll(val){ uploadDayCheckboxEls().forEach(cb => cb.checked = !!val); }
    function selectedUploadDates(){
      if(!state.weekStart) return [];
      const base = new Date(state.weekStart);
      const idxs = uploadDayCheckboxEls().filter(cb => cb.checked).map(cb => parseInt(cb.getAttribute('data-upday'),10));
      return idxs.map(i => toISO(addDays(base, i)));
    }
    function buildPayloadFiltered(dates){
      const set = new Set(dates || []);
      const out = { version:1, tz:state.tz, athlete_id:Number(state.athleteId||0), week_start:state.weekStart, workouts:[] };
      Object.entries(state.days).forEach(([iso, list])=>{
        if(!set.has(iso)) return;
        (list || []).forEach(w=>{
          const wo = {
            date: iso,
            name: w.name || '',
            type: w.type || 'Ride',
            indoor: !!w.indoor,
            duration_sec: Number(w.duration_sec || 0),
            tss: Number(w.tss || 0),
            notes: w.notes || ''
          };
          if (w.design && Object.keys(w.design).length) wo.design = w.design;
          out.workouts.push(wo);
        });
      });
      return out;
    }
    function countFilteredWorkouts(dates){ return buildPayloadFiltered(dates).workouts.length; }

    // ---------- Upload tab helpers ----------
    function buildDaysBulletsHTML(dates){
      const items = dates.map(iso=>{
        const list  = state.days[iso] || [];
        const names = list.length
          ? list.map(w => escHtml(w.name || 'Untitled')).join(' · ')
          : '<span class="text-slate-400">(no workouts)</span>';
        const d = new Date(iso+'T00:00:00Z');
        const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getUTCDay()];
        return `<li><b>${dow} — ${iso}</b>: ${names}</li>`;
      }).join('');
      return `<ul class="list-disc pl-6 space-y-1">${items}</ul>`;
    }
    function updateUploadHint(){
      if(!state.weekStart){ $('#uploadHint').textContent='Pick a week on the Plan tab.'; return; }
      const dates = selectedUploadDates();
      const nWos = countFilteredWorkouts(dates);
      const nDays = dates.length;
      const btn = $('#uploadIntervalsBtn');
      btn.textContent = nWos ? `Upload to Intervals (${nWos})` : 'Upload to Intervals';
      btn.disabled = nWos === 0;
      $('#uploadHint').innerHTML = nDays ? `Selected <b>${nDays}</b> day(s), <b>${nWos}</b> workout(s).` : 'No days selected.';
    }

    // ---------- Modal / toast ----------
    function confirmDialog({title, html}){
      return new Promise(res=>{
        $('#modalTitle').textContent = title || 'Confirm';
        $('#modalBody').innerHTML = html || '';
        $('#modal').classList.remove('hidden');
        const ok = ()=>{ cleanup(); res(true); };
        const cancel = ()=>{ cleanup(); res(false); };
        const cleanup = ()=>{
          $('#modal').classList.add('hidden');
          $('#modalOk').removeEventListener('click', ok);
          $('#modalCancel').removeEventListener('click', cancel);
        };
        $('#modalOk').addEventListener('click', ok, {once:true});
        $('#modalCancel').addEventListener('click', cancel, {once:true});
      });
    }
    function toast(msg, kind='ok', ms=2000){
      const t = $('#toast');
      t.textContent = msg;
      t.className = `fixed bottom-4 right-4 z-50 px-3 py-2 rounded-lg border ${kind==='ok'?'bg-green-600 text-white border-green-700': kind==='warn'?'bg-amber-500 text-white border-amber-600':'bg-slate-800 text-white border-slate-700'}`;
      t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), ms);
    }

    // ---------- GitHub API ----------
    function ghGetCfg(){
      return {
        token: localStorage.getItem('ghToken') || '',
        owner: localStorage.getItem('ghOwner') || '',
        repo:  localStorage.getItem('ghRepo')  || '',
        branch:localStorage.getItem('ghBranch')|| 'main',
        prefix:localStorage.getItem('ghPrefix')|| 'plans'
      };
    }
    function ghSetCfg(cfg){
      localStorage.setItem('ghToken', cfg.token||'');
      localStorage.setItem('ghOwner', cfg.owner||'');
      localStorage.setItem('ghRepo',  cfg.repo||'');
      localStorage.setItem('ghBranch',cfg.branch||'main');
      localStorage.setItem('ghPrefix',cfg.prefix||'plans');
    }
    function githubHeaders(token){
      return {
        'Accept':'application/vnd.github+json',
        'Authorization': token ? `Bearer ${token}` : undefined
      };
    }
    async function githubGetFile(cfg, path){
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(cfg.branch)}`;
      const r = await fetch(url, {headers: githubHeaders(cfg.token)});
      if(!r.ok) throw new Error(`GET ${path}: ${r.status}`);
      const j = await r.json();
      const content = j.content ? atob(j.content.replace(/\n/g,'')) : '';
      return { sha: j.sha, content, html_url: j.html_url, path };
    }
    async function githubPutFile(cfg, path, content, message){
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
      let sha;
      try{
        const prev = await githubGetFile(cfg, path);
        sha = prev.sha;
      }catch(e){ /* new file */ }
      const body = {
        message: message || `update ${path}`,
        content: btoa(unescape(encodeURIComponent(content))),
        branch: cfg.branch,
        sha
      };
      const r = await fetch(url, {
        method:'PUT',
        headers: {'Accept':'application/vnd.github+json','Authorization': `Bearer ${cfg.token}`,'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(`PUT ${path}: ${r.status}`);
      return r.json();
    }
    async function ghListPlans(cfg){
      const dir = (cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(dir)}?ref=${encodeURIComponent(cfg.branch)}`;
      const r = await fetch(url, {headers: githubHeaders(cfg.token)});
      if(!r.ok) throw new Error(`List ${dir}: ${r.status}`);
      const j = await r.json();
      return j.filter(x=> x.type==='file' && x.name.endsWith('.json')).map(x=> x.path);
    }
    async function ghGetJsonFile(cfg, path){
      const {content, html_url} = await githubGetFile(cfg, path);
      return { data: JSON.parse(content), html_url };
    }
    async function ghDispatchWorkflow(cfg, workflowFile, inputs){
      const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/actions/workflows/${encodeURIComponent(workflowFile)}/dispatches`;
      const body = { ref: cfg.branch, inputs: inputs || {} };
      const r = await fetch(url, {
        method:'POST',
        headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${cfg.token}`,'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(`Dispatch ${workflowFile}: ${r.status}`);
    }

    // ---------- Save / Load ----------
    async function saveToRepo(){
      const cfg = ghGetCfg();
      if(!cfg.token||!cfg.owner||!cfg.repo){ toast('Missing GitHub settings.','warn',2500); switchTopTab('settings'); return; }
      if(!state.weekStart){ toast('Pick a week start first.','warn'); return; }
      const prefix = (cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
      const path = `${prefix}/plan-${state.weekStart}.json`;
      const content = JSON.stringify(buildPayload(), null, 2);
      await githubPutFile(cfg, path, content, `feat(planner): save ${path}`);
      $('#saveHint').textContent = `Saved ${path}`;
      toast('Plan saved to repo.','ok');
    }
    async function refreshPlanList(){
      const cfg = ghGetCfg();
      if(!cfg.token||!cfg.owner||!cfg.repo){ $('#loadHint').textContent='Set GitHub settings first.'; return; }
      try{
        const paths = await ghListPlans(cfg);
        const sel = $('#planList');
        sel.innerHTML = paths.map(p=> `<option value="${escHtml(p)}">${escHtml(p)}</option>`).join('');
        $('#loadHint').textContent = `${paths.length} plan(s) found.`;
        const cfgPrefix = (cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
        $('#openPlanLink').href = paths.length ? `https://github.com/${cfg.owner}/${cfg.repo}/blob/${encodeURIComponent(cfg.branch)}/${paths[0]}` : '#';
      }catch(e){
        $('#loadHint').textContent = `Error: ${e.message}`;
      }
    }
    async function loadSelectedPlan(){
      const cfg = ghGetCfg();
      const path = $('#planList').value;
      if(!path){ toast('No plan selected.','warn'); return; }
      try{
        const {data, html_url} = await ghGetJsonFile(cfg, path);
        applyPlanData(data);
        $('#openPlanLink').href = html_url;
        toast('Plan loaded.','ok');
      }catch(e){
        toast('Load failed: '+e.message,'warn',3000);
      }
    }
    function applyPlanData(plan){
      state.tz = plan.tz || state.tz;
      state.athleteId = Number(plan.athlete_id || 0);
      state.weekStart = plan.week_start || state.weekStart;
      $('#tzBadge').textContent = state.tz;
      $('#weekStart').value = state.weekStart || '';
      state.days = {};
      (plan.workouts||[]).forEach(w=>{
        const iso = w.date;
        if(!iso) return;
        if(!state.days[iso]) state.days[iso]=[];
        state.days[iso].push({
          name: w.name||'',
          type: w.type||'Ride',
          indoor: !!w.indoor,
          duration_sec: Number(w.duration_sec||0),
          tss: Number(w.tss||0),
          notes: w.notes||'',
          design: w.design||undefined
        });
      });
      setSelectedDay(0);
      updateTotals();
      updateUploadHint();
    }

    // ---------- Upload to Intervals (filtered) ----------
    async function saveThenUpload(){
      if(!state.weekStart){ alert('Pick a week start first.'); return; }
      const dates = selectedUploadDates();
      if (dates.length === 0) { alert('Select at least one day.'); return; }

      const full = buildPayload();
      const part = buildPayloadFiltered(dates);
      const n = part.workouts.length;
      const bullets = buildDaysBulletsHTML(dates);

      const html = `<div class="space-y-2">
        <div>Week: <b>${full.week_start}</b></div>
        <div>Time zone: <code>${escHtml(full.tz)}</code></div>
        <div>Athlete ID: <code>${full.athlete_id}</code></div>
        <div class="mt-2">${bullets}</div>
        <div class="text-rose-600 font-medium">This will upload <b>${n}</b> workout(s) for the selected day(s). Continue?</div>
      </div>`;
      const ok = await confirmDialog({title:'Upload to Intervals', html});
      if(!ok) return;

      const cfg = ghGetCfg();
      const prefix = (cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
      // Save full week
      const fullPath = `${prefix}/plan-${state.weekStart}.json`;
      await githubPutFile(cfg, fullPath, JSON.stringify(full,null,2), `feat(planner): save ${fullPath}`);

      // Save filtered copy (if partial)
      let dispatchPath = fullPath;
      if (dates.length !== 7) {
        const short = dates.map(d=>d.slice(8,10)).join('');
        const partialDir = `${prefix}/partial`;
        const partialPath = `${partialDir}/plan-${state.weekStart}-d${short}.json`;
        await githubPutFile(cfg, partialPath, JSON.stringify(part,null,2), `feat(planner): save ${partialPath}`);
        dispatchPath = partialPath;
      }

      await ghDispatchWorkflow(cfg, 'upload-week-plan.yml', {
        plan_path: dispatchPath,
        tz: full.tz || 'America/Los_Angeles',
        athlete_id: String(full.athlete_id || 0),
        default_start: '06:00',
        dry_run: 'false'
      });

      const runsUrl = `https://github.com/${cfg.owner}/${cfg.repo}/actions/workflows/upload-week-plan.yml`;
      toast(`Upload dispatched for ${n} workout(s).`, 'ok', 3500);
      const hint = $('#uploadHint');
      if(hint) hint.innerHTML = `Dispatched ✓ — <a class="underline" target="_blank" href="${runsUrl}">view workflow runs</a>.`;
    }

    // ---------- Settings ----------
    function loadSettingsIntoUI(){
      const cfg = ghGetCfg();
      $('#ghToken').value = cfg.token;
      $('#ghOwner').value = cfg.owner || 'tomeese';
      $('#ghRepo').value  = cfg.repo  || 'intervals-icu-bulk-uploader-planned-workouts';
      $('#ghBranch').value= cfg.branch|| 'main';
      $('#ghPrefix').value= cfg.prefix|| 'plans';
      $('#inpTz').value   = state.tz;
      $('#inpAthlete').value = String(state.athleteId||0);
      $('#tzBadge').textContent = state.tz;
    }
    function saveSettingsFromUI(){
      const cfg = {
        token: $('#ghToken').value.trim(),
        owner: $('#ghOwner').value.trim(),
        repo:  $('#ghRepo').value.trim(),
        branch:$('#ghBranch').value.trim() || 'main',
        prefix:$('#ghPrefix').value.trim() || 'plans'
      };
      ghSetCfg(cfg);
      state.tz = $('#inpTz').value.trim() || state.tz;
      state.athleteId = Number($('#inpAthlete').value||0);
      $('#tzBadge').textContent = state.tz;
      toast('Settings saved.','ok');
    }

    // ---------- Boot ----------
    function bindGlobal(){
      // Top tabs
      initTopTabs();

      // Plan header
      $('#loadTemplateBtn').addEventListener('click', ()=> applyTemplate($('#templateSelect').value));
      $('#newWeekBtn').addEventListener('click', ()=>{
        if(!confirm('Clear all days for this week?')) return;
        Object.keys(state.days).forEach(k=> delete state.days[k]);
        renderDay(isoForDayIndex(state.selectedDay||0)); updateTotals(); updateUploadHint();
      });
      $('#weekStart').addEventListener('change', ()=>{
        state.weekStart = $('#weekStart').value || null;
        setSelectedDay(0);
        updateTotals();
        updateUploadHint();
      });

      // Day tabs
      bindDayTabs();

      // Load & Save
      $('#saveRepoBtn').addEventListener('click', saveToRepo);
      $('#exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(buildPayload(),null,2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `plan-${state.weekStart||today()}.json`; a.click();
        URL.revokeObjectURL(a.href);
      });
      $('#refreshPlansBtn').addEventListener('click', refreshPlanList);
      $('#loadPlanBtn').addEventListener('click', loadSelectedPlan);

      // Upload
      $('#uploadIntervalsBtn').addEventListener('click', saveThenUpload);
      $('#upSelectAll').addEventListener('change', e=>{ setUploadDaysAll(e.target.checked); updateUploadHint(); });
      uploadDayCheckboxEls().forEach(cb=> cb.addEventListener('change', ()=>{
        const allChecked = uploadDayCheckboxEls().every(x=> x.checked);
        $('#upSelectAll').checked = allChecked;
        updateUploadHint();
      }));
      $('#upWeekdays').addEventListener('click', ()=>{
        uploadDayCheckboxEls().forEach((cb,i)=> cb.checked = (i>=0 && i<=4));
        $('#upSelectAll').checked = false; updateUploadHint();
      });
      $('#upWeekend').addEventListener('click', ()=>{
        uploadDayCheckboxEls().forEach((cb,i)=> cb.checked = (i===5 || i===6));
        $('#upSelectAll').checked = false; updateUploadHint();
      });

      // Settings
      $('#saveGhCfg').addEventListener('click', saveSettingsFromUI);
      $('#clearGhCfg').addEventListener('click', ()=>{ localStorage.removeItem('ghToken'); $('#ghToken').value=''; toast('Token cleared.','ok'); });
      $('#testGhBtn').addEventListener('click', async ()=>{
        try{
          const cfg = ghGetCfg();
          const dir = (cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
          const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(dir)}?ref=${encodeURIComponent(cfg.branch)}`;
          const r = await fetch(url, {headers: githubHeaders(cfg.token)});
          $('#ghHint').textContent = r.ok ? 'GitHub OK.' : `GitHub error: ${r.status}`;
        }catch(e){ $('#ghHint').textContent = 'GitHub error: '+e.message; }
      });
    }

    (function boot(){
      // Defaults
      state.weekStart = mondayOfCurrentWeek();
      $('#weekStart').value = state.weekStart;
      loadSettingsIntoUI();
      bindGlobal();
      setSelectedDay(0);
      refreshPlanList();
      updateUploadHint();
    })();
  </script>
</body>
</html>
