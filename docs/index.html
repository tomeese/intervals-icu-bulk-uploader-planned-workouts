<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Weekly Workout Planner</title>
  <meta name="color-scheme" content="light dark"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--ring:0 0 0 2px rgba(37,99,235,.35)}
    .card{border-radius:.75rem}
    /* Give each day the full width and let content expand naturally */
    .scroll-area{max-height:none;overflow:visible}
    .field{display:flex;flex-direction:column;gap:.45rem}
    .lbl{font-size:.85rem;line-height:1.1rem;color:rgb(100 116 139)}
    .inp{width:100%;padding:.6rem .7rem;border-radius:.6rem;border:1px solid rgb(203 213 225)}
    .inp.dark{border-color:rgb(51 65 85);background:rgb(15 23 42)}
    .inp:focus{outline:none;box-shadow:var(--ring)}
    .sm-btn{padding:.5rem .75rem;border-radius:.55rem;border:1px solid rgb(203 213 225)}
    .row-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:.75rem}
    /* Single-day per row across breakpoints */
    #daysGrid{display:grid;grid-template-columns:1fr;gap:1rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
  <!-- Error banner -->
  <div id="errBanner" class="hidden bg-rose-600 text-white text-sm px-4 py-2"></div>

  <header class="bg-white/70 dark:bg-slate-900/60 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex items-center justify-between gap-4">
      <h1 class="text-2xl font-semibold tracking-tight">Weekly Workout Planner</h1>
      <div class="hidden sm:flex items-center gap-2 text-xs text-slate-500">
        <span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800">1) Plan</span>→
        <span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800">2) Save / Upload</span>→
        <span class="px-2 py-1 rounded-full bg-slate-100 dark:bg-slate-800">3) Day-of ZWO</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- LEFT: Planner -->
    <section class="lg:col-span-2 space-y-6">
      <!-- Week toolbar -->
      <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <label class="field">
            <span class="lbl">Week start (Monday)</span>
            <input id="weekStart" type="date" class="inp dark"/>
          </label>
          <label class="field">
            <span class="lbl">Time zone (IANA)</span>
            <input id="tz" type="text" value="America/Los_Angeles" class="inp dark"/>
          </label>
          <label class="field">
            <span class="lbl">Athlete ID</span>
            <input id="athleteId" type="number" value="0" class="inp dark"/>
          </label>
          <div class="flex items-end">
            <button id="newWeekBtn" class="w-full rounded-lg bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 font-medium">Clear week</button>
          </div>
        </div>
      </div>

      <!-- Phase & Template -->
      <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Macro-phase & templates</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <label class="field">
            <span class="lbl">Macro-phase</span>
            <select id="phase" class="inp dark"><option>Base</option><option>Build</option><option>Specialty</option></select>
          </label>
          <label class="field">
            <span class="lbl">Week focus</span>
            <select id="focus" class="inp dark"><option>Build</option><option>Recovery</option></select>
          </label>
          <label class="field md:col-span-2">
            <span class="lbl">Template</span>
            <select id="templateKey" class="inp dark"><option value="">— choose phase & focus —</option></select>
            <div id="templateDesc" class="mt-1 text-xs text-slate-500"></div>
          </label>
          <div class="flex items-end">
            <button id="loadTemplateBtn" class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 font-medium">Load template</button>
          </div>
        </div>
      </div>

      <!-- Days (now one per row, full-width) -->
      <section id="daysGrid" class="gap-4"></section>
    </section>

    <!-- RIGHT: Sidebar -->
    <aside class="lg:col-span-1 space-y-6">
      <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 p-4 sticky top-4">
        <h2 class="text-lg font-semibold mb-3">Totals</h2>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
            <div class="text-xs text-slate-500">Planned Time</div>
            <div id="totPlannedTime" class="text-base font-semibold">0h 00m</div>
          </div>
          <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
            <div class="text-xs text-slate-500">Planned TSS</div>
            <div id="totPlannedTss" class="text-base font-semibold">0</div>
          </div>
          <div class="col-span-2 p-3 rounded-lg bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
            <div class="text-xs text-slate-500 mb-1">By Type</div>
            <div id="totByType" class="text-sm leading-6">—</div>
          </div>
        </div>

        <div class="mt-5 space-y-2">
          <button id="exportBtn" class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 font-medium">Export JSON</button>
          <button id="saveRepoBtn" class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 font-medium">Save to repo</button>
          <button id="uploadIntervalsBtn" class="w-full rounded-lg bg-rose-600 hover:bg-rose-500 text-white px-3 py-2 font-medium">Upload to Intervals</button>

          <label class="field mt-3">
            <span class="lbl">Import JSON</span>
            <input id="importFile" type="file" accept="application/json" class="text-sm"/>
          </label>

          <!-- Load from repo -->
          <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-medium">Load Week Plan from repo</h3>
              <div class="flex gap-2">
                <button id="testGhBtn" class="sm-btn bg-slate-50 dark:bg-slate-900">Test GitHub</button>
                <button id="refreshPlansBtn" class="sm-btn bg-slate-50 dark:bg-slate-900">Refresh</button>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 mt-2">
              <select id="loadPlanSelect" class="sm:col-span-3 inp dark"><option value="">— select plan —</option></select>
              <button id="loadPlanBtn" class="rounded-lg bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 text-sm">Load</button>
              <a id="openPlanLink" href="#" target="_blank" class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm text-slate-700 dark:text-slate-200 text-center">Open on GitHub</a>
            </div>
            <div id="loadPlanMsg" class="text-xs text-slate-500 mt-2"></div>
          </div>

          <!-- GitHub settings -->
          <details class="mt-4" open>
            <summary class="cursor-pointer text-sm font-medium">GitHub save settings</summary>
            <div class="mt-3 text-xs text-slate-500">Stored only in this browser.</div>
            <label class="field mt-2">
              <span class="lbl">Personal Access Token (fine-grained)</span>
              <input id="ghToken" type="password" placeholder="ghp_…" class="inp dark"/>
            </label>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <label class="field"><span class="lbl">Owner</span><input id="ghOwner" value="tomeese" class="inp dark"/></label>
              <label class="field"><span class="lbl">Repo</span><input id="ghRepo" value="intervals-icu-bulk-uploader-planned-workouts" class="inp dark"/></label>
              <label class="field"><span class="lbl">Branch</span><input id="ghBranch" value="main" class="inp dark"/></label>
              <label class="field"><span class="lbl">Path prefix</span><input id="ghPrefix" value="plans" class="inp dark"/></label>
            </div>
            <div class="flex items-center gap-2 mt-3">
              <button id="saveGhCfg" class="sm-btn bg-slate-50 dark:bg-slate-900">Save settings</button>
              <span id="saveGhMsg" class="text-xs text-emerald-500"></span>
              <button id="clearGhCfg" class="ml-auto sm-btn border-rose-300 dark:border-rose-700">Clear token</button>
            </div>
          </details>
        </div>
      </div>
    </aside>
  </main>

  <!-- Day card template -->
  <template id="dayCardTpl">
    <div class="card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800">
      <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-800">
        <div>
          <div class="text-sm text-slate-500" data-day-name>Monday</div>
          <div class="text-lg font-semibold" data-day-date>2025-01-01</div>
        </div>
        <div class="flex gap-2">
          <button class="sm-btn" data-copy-prev>Copy prev</button>
          <button class="sm-btn" data-clear>Clear</button>
          <button class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm" data-add>Add</button>
        </div>
      </div>
      <div class="p-4 scroll-area" data-rows></div>
    </div>
  </template>

  <!-- Workout row template (all JSON fields visible) -->
  <template id="rowTpl">
    <div class="py-4 border-b border-slate-100 dark:border-slate-900 last:border-0">
      <div class="row-grid">
        <label class="field col-span-6">
          <span class="lbl">Name</span>
          <input type="text" class="inp dark" placeholder="Endurance Z2 - 2h" data-name/>
        </label>
        <label class="field col-span-3">
          <span class="lbl">Type</span>
          <select class="inp dark" data-type>
            <option>Ride</option><option>Gravel Ride</option><option>Virtual Ride</option>
          </select>
        </label>
        <label class="field col-span-3">
          <span class="lbl">Indoor</span>
          <input type="checkbox" class="h-5 w-5 mt-2" data-indoor/>
        </label>

        <label class="field col-span-3">
          <span class="lbl">Duration (HH:MM)</span>
          <input type="time" step="60" class="inp dark" value="01:00" data-duration/>
        </label>
        <label class="field col-span-3">
          <span class="lbl">TSS</span>
          <input type="number" min="0" step="1" class="inp dark" value="50" data-tss/>
        </label>
        <label class="field col-span-6">
          <span class="lbl">Notes</span>
          <input type="text" class="inp dark" placeholder="Optional" data-notes/>
        </label>
      </div>

      <div class="mt-3 flex flex-wrap gap-2 justify-end">
        <button class="sm-btn" data-design-btn>Design</button>
        <button class="sm-btn" data-zwo>ZWO</button>
        <button class="sm-btn border-rose-300 text-rose-600" data-del>Delete</button>
      </div>

      <!-- DESIGN (optional JSON 'design' block) -->
      <div class="hidden rounded-lg border border-slate-200 dark:border-slate-700 p-3 bg-slate-50 dark:bg-slate-900 mt-3" data-design-panel>
        <div class="text-xs text-slate-500 mb-2">Workout design (saved into JSON for ZWO)</div>
        <div class="row-grid">
          <label class="field col-span-3"><span class="lbl">FTP (W)</span><input type="number" min="50" max="600" step="1" class="inp dark" data-d-ftp></label>
          <label class="field col-span-3"><span class="lbl">Sets</span><input type="number" min="1" max="20" step="1" class="inp dark" data-d-sets></label>
          <label class="field col-span-3"><span class="lbl">Work (sec)</span><input type="number" min="15" max="7200" step="5" class="inp dark" data-d-work></label>
          <label class="field col-span-3"><span class="lbl">Rest (sec)</span><input type="number" min="10" max="7200" step="5" class="inp dark" data-d-rec></label>

          <label class="field col-span-3"><span class="lbl">Target %FTP</span><input type="number" min="0.3" max="1.8" step="0.01" placeholder="0.95" class="inp dark" data-d-target></label>
          <label class="field col-span-3"><span class="lbl">Over/Under</span><input type="checkbox" class="h-5 w-5 mt-2" data-d-ou></label>
          <label class="field col-span-3"><span class="lbl">Under %FTP</span><input type="number" min="0.3" max="1.5" step="0.01" placeholder="0.95" class="inp dark" data-d-under></label>
          <label class="field col-span-3"><span class="lbl">Over %FTP</span><input type="number" min="0.3" max="1.8" step="0.01" placeholder="1.05" class="inp dark" data-d-over></label>

          <label class="field col-span-3"><span class="lbl">Warmup (sec)</span><input type="number" min="60" max="3600" step="30" placeholder="600" class="inp dark" data-d-warm></label>
          <label class="field col-span-3"><span class="lbl">Cooldown (sec)</span><input type="number" min="60" max="3600" step="30" placeholder="600" class="inp dark" data-d-cool></label>
          <label class="field col-span-3"><span class="lbl">Cadence (rpm)</span><input type="number" min="50" max="130" step="1" class="inp dark" data-d-cad></label>
          <label class="field col-span-3"><span class="lbl">ERG</span><input type="checkbox" class="h-5 w-5 mt-2" data-d-erg checked></label>
        </div>
        <div class="mt-2 flex gap-2 justify-end">
          <button class="sm-btn" data-design-cancel>Close</button>
          <button class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-xs" data-design-save>Save</button>
        </div>
      </div>
    </div>
  </template>

  <script>
  // ---------- Error banner ----------
  function showErr(msg){const b=document.getElementById('errBanner');b.textContent=String(msg||'Unknown error');b.classList.remove('hidden');console.error('[planner]', msg);}
  window.addEventListener('error', e=>showErr(e.message||e.error||e));

  // ---------- Utilities ----------
  const $=s=>document.querySelector(s);
  const dayNames=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const fmtHMS=sec=>{sec=Math.max(0,Math.round(sec));const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60);return `${h}h ${String(m).padStart(2,'0')}m`;};
  const parseHHMM=v=>{if(!v)return 0;const [h,m]=(v||'').split(':').map(x=>parseInt(x||'0',10));return (isNaN(h)||isNaN(m))?0:h*3600+m*60;};
  const mondayOf=date=>{const d=new Date(date);const gd=d.getDay();const diff=(gd===0?-6:1-gd);d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;};
  const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;};
  const toISODate=d=>d.toISOString().slice(0,10);
  const hhmmFromSec=s=>{s=Math.max(0,Math.round(s));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;};
  const numOrNull=x=>{const v=Number(x);return Number.isFinite(v)?v:null;};
  const defaultTargetPctByName=n=>/sweet\s*spot/i.test(n||'')?0.88:/threshold/i.test(n||'')?0.95:/vo2/i.test(n||'')?1.2:/anaerobic|sprint/i.test(n||'')?1.5:0.9;
  const safeFilename=name=>(name||'file').replace(/[^\w\-.]+/g,'_').slice(0,120);
  const base64EncodeUTF8=str=>btoa(unescape(encodeURIComponent(str)));
  const encodePathPreserveSlashes=p=>p.split('/').map(encodeURIComponent).join('/');

  // ---------- State ----------
  const state={weekStart:null,tz:'America/Los_Angeles',athleteId:0,days:{}};
  const storageKey=()=>`planner:${state.weekStart}`;
  const save=()=>{if(!state.weekStart)return; localStorage.setItem(storageKey(), JSON.stringify(state));};
  const loadWeek=week=>{const raw=localStorage.getItem(`planner:${week}`); try{return raw?JSON.parse(raw):null}catch(_){return null}};

  // ---------- Templates ----------
  const TEMPLATES={
    "Base":{"Build":{"Base-1 (endurance focus)":{
      desc:"Mostly Z2 endurance with light tempo. Long ride Sat.",
      days:{0:[{name:"Rest or 45' Recovery",type:"Ride",indoor:false,duration_sec:2700,tss:20,notes:"Optional spin"}],
            1:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}],
            2:[{name:"Tempo 2x20' @85%",type:"Virtual Ride",indoor:true,duration_sec:4800,tss:70}],
            3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:40}],
            4:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}],
            5:[{name:"Long Endurance Z2 - 3h",type:"Ride",indoor:false,duration_sec:10800,tss:135}],
            6:[{name:"Endurance Z2 - 2h",type:"Ride",indoor:false,duration_sec:7200,tss:90}]}}},
      "Recovery":{"Recovery-Base":{
        desc:"Reduced volume, no intensity.",
        days:{0:[],1:[{name:"Recovery Spin - 45m",type:"Virtual Ride",indoor:true,duration_sec:2700,tss:20}],2:[],
              3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],
              4:[],5:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}],6:[]}}}
    },
    "Build":{"Build":{"Threshold-1":{
      desc:"Threshold focus: 3x12' and 4x8'.",
      days:{0:[],1:[{name:"Threshold 3x12' @95%",type:"Virtual Ride",indoor:true,duration_sec:5400,tss:80}],
            2:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:40}],
            3:[{name:"Threshold 4x8' @100%",type:"Virtual Ride",indoor:true,duration_sec:4800,tss:80}],
            4:[],5:[{name:"Sweet Spot 3x20' @88%",type:"Ride",indoor:false,duration_sec:7200,tss:110}],
            6:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}]}}},
      "Recovery":{"Recovery-Build":{
        desc:"Keep legs spinning; minimal intensity.",
        days:{0:[],1:[{name:"Recovery Spin - 45m",type:"Virtual Ride",indoor:true,duration_sec:2700,tss:20}],2:[],
              3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],
              4:[],5:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:55}],6:[]}}}
    },
    "Specialty":{"Build":{"VO2/Anaerobic-1":{
      desc:"VO2Max + Anaerobic focus.",
      days:{0:[],1:[{name:"VO2Max 5x3' @120%",type:"Virtual Ride",indoor:true,duration_sec:4200,tss:75}],
            2:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:40}],
            3:[{name:"VO2Max 6x2' @125%",type:"Virtual Ride",indoor:true,duration_sec:3600,tss:70}],
            4:[],5:[{name:"Anaerobic 8x1' @150%",type:"Virtual Ride",indoor:true,duration_sec:3600,tss:65}],
            6:[{name:"Endurance Z2 - 90m",type:"Ride",indoor:false,duration_sec:5400,tss:60}]}}},
      "Recovery":{"Recovery-Specialty":{
        desc:"Strip intensity, keep short endurance.",
        days:{0:[],1:[{name:"Recovery Spin - 45m",type:"Virtual Ride",indoor:true,duration_sec:2700,tss:20}],2:[],
              3:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],
              4:[],5:[{name:"Endurance Z2 - 60m",type:"Ride",indoor:false,duration_sec:3600,tss:35}],6:[]}}}
    }
  };

  // ---------- GitHub helpers (hardened & with public fallback) ----------
  const GH_STORE_KEY='planner:ghcfg';
  const ghLoad=()=>{try{return JSON.parse(localStorage.getItem(GH_STORE_KEY)||'{}')}catch(_){return{}}};
  const ghSaveCfg=cfg=>localStorage.setItem(GH_STORE_KEY, JSON.stringify(cfg||{}));
  function cleanToken(t){ return (t||'').replace(/[\u2000-\u200B\u202F\u205F\uFEFF]/g,'').trim(); }
  function ghGetCfg(){
    const saved=ghLoad();
    return {
      token: ($('#ghToken')?.value) || saved.token || "",
      owner: ($('#ghOwner')?.value) || saved.owner || "tomeese",
      repo:  ($('#ghRepo') ?.value) || saved.repo  || "intervals-icu-bulk-uploader-planned-workouts",
      branch:($('#ghBranch')?.value) || saved.branch|| "main",
      prefix:($('#ghPrefix')?.value) || saved.prefix|| "plans"
    };
  }
  async function ghFetch(url, token, init){
    const tok = cleanToken(token||'');
    const headers = Object.assign({Accept:"application/vnd.github+json"}, tok?{Authorization:'token '+tok}:{});
    const req = Object.assign({headers}, init||{});
    try { 
      return await fetch(url, req);
    } catch (e) {
      if (tok) { // try unauthenticated (public) as fallback
        return await fetch(url, Object.assign({headers:{Accept:"application/vnd.github+json"}}, init||{}));
      }
      throw e;
    }
  }
  async function githubPutFile(cfg, path, text, message){
    const api=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodePathPreserveSlashes(path)}`;
    const getRes=await ghFetch(`${api}?ref=${encodeURIComponent(cfg.branch)}`, cfg.token);
    let sha=null;
    if(getRes.status===200){ sha=(await getRes.json()).sha; }
    else if(getRes.status!==404){ throw new Error(`GET ${getRes.status}: ${await getRes.text()}`); }
    const body={message:message||`save ${path}`,content:base64EncodeUTF8(text),branch:cfg.branch,sha,
      committer:{name:"planner-bot",email:"planner@users.noreply.github.com"},
      author:{name:"planner-bot",email:"planner@users.noreply.github.com"}};
    const putRes=await ghFetch(api, cfg.token, {method:'PUT',body:JSON.stringify(body)});
    const txt=await putRes.text(); if(!putRes.ok) throw new Error(`PUT ${putRes.status}: ${txt.slice(0,400)}`); return JSON.parse(txt);
  }
  async function ghDispatchWorkflow(cfg, workflowFile, inputs){
    const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/actions/workflows/${encodeURIComponent(workflowFile)}/dispatches`;
    const res=await ghFetch(url, cfg.token, {method:"POST",body:JSON.stringify({ref:cfg.branch,inputs:inputs||{}})});
    if(!res.ok) throw new Error(`dispatch ${res.status}: ${await res.text()}`);
    return true;
  }
  async function ghListPlans(cfg, prefix="plans"){
    const p=(prefix||"plans").replace(/^\/+|\/+$/g,"");
    const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodePathPreserveSlashes(p)}?ref=${encodeURIComponent(cfg.branch)}`;
    const res=await ghFetch(url, cfg.token);
    if(!res.ok){ throw new Error(`list ${res.status}: ${await res.text()}`); }
    const items=await res.json();
    return (Array.isArray(items)?items:[])
      .filter(it=>it.type==="file" && /^plan-\d{4}-\d{2}-\d{2}\.json$/.test(it.name))
      .map(it=>({name:it.name,path:it.path}));
  }
  async function ghGetJsonFile(cfg, path){
    const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodePathPreserveSlashes(path)}?ref=${encodeURIComponent(cfg.branch)}`;
    const res=await ghFetch(url, cfg.token);
    if(!res.ok) throw new Error(`get ${res.status}: ${await res.text()}`);
    const obj=await res.json(); const txt=atob((obj.content||"").replace(/\n/g,'')); return JSON.parse(txt);
  }

  // ---------- Template handling ----------
  function updateTemplateList(){
    try{
      const phase=$('#phase').value, focus=$('#focus').value;
      const group=(TEMPLATES[phase]&&TEMPLATES[phase][focus])?TEMPLATES[phase][focus]:{};
      const sel=$('#templateKey'), desc=$('#templateDesc');
      sel.innerHTML='';
      const keys=Object.keys(group);
      if(keys.length){
        keys.forEach(k=>{const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o);});
        sel.value=keys[0]; desc.textContent=group[keys[0]].desc||'';
      }else{
        sel.innerHTML='<option value="">— no templates —</option>'; desc.textContent='No templates for this selection.';
      }
    }catch(e){ showErr(e.message||e); }
  }
  function applyTemplate(){
    const phase=$('#phase').value, focus=$('#focus').value, key=$('#templateKey').value;
    const g=TEMPLATES[phase]&&TEMPLATES[phase][focus]?TEMPLATES[phase][focus]:null;
    const tpl=g&&g[key]; if(!tpl){ alert('No template for selection'); return; }
    if(!state.weekStart){ alert('Pick a week start first.'); return; }
    const base=new Date(state.weekStart); state.days={};
    Object.entries(tpl.days).forEach(([idx,lst])=>{
      const iso=toISODate(addDays(base,parseInt(idx,10)));
      state.days[iso]=(lst||[]).map(w=>({...w}));
    });
    save(); renderWeek();
  }

  // ---------- Render ----------
  function renderWeek(){
    const grid=$('#daysGrid'); grid.innerHTML='';
    if(!state.weekStart) return;
    const base=new Date(state.weekStart);
    for(let i=0;i<7;i++){
      const d=addDays(base,i), iso=toISODate(d);
      const card=document.importNode($('#dayCardTpl').content,true);
      card.querySelector('[data-day-name]').textContent=dayNames[i];
      card.querySelector('[data-day-date]').textContent=iso;
      const rows=card.querySelector('[data-rows]');
      (state.days[iso]||[]).forEach(w=>rows.appendChild(renderRow(iso,w)));
      card.querySelector('[data-add]').addEventListener('click',()=>{
        const w={name:'',type:'Ride',indoor:false,duration_sec:3600,tss:50,notes:''};
        (state.days[iso] ||= []).push(w);
        rows.appendChild(renderRow(iso,w)); totals(); save();
      });
      card.querySelector('[data-clear]').addEventListener('click',()=>{
        state.days[iso]=[]; rows.innerHTML=''; totals(); save();
      });
      card.querySelector('[data-copy-prev]').addEventListener('click',()=>{
        if(i===0) return;
        const prev=toISODate(addDays(base,i-1));
        const cp=(state.days[prev]||[]).map(w=>({...w}));
        state.days[iso]=cp; rows.innerHTML=''; cp.forEach(w=>rows.appendChild(renderRow(iso,w))); totals(); save();
      });
      grid.appendChild(card);
    }
    totals();
  }

  function renderRow(iso,w){
    const frag=document.importNode($('#rowTpl').content,true);
    const el=frag.firstElementChild;
    const $name=el.querySelector('[data-name]'), $type=el.querySelector('[data-type]'), $ind=el.querySelector('[data-indoor]');
    const $dur=el.querySelector('[data-duration]'), $tss=el.querySelector('[data-tss]'), $notes=el.querySelector('[data-notes]');
    const $designBtn=el.querySelector('[data-design-btn]'), $panel=el.querySelector('[data-design-panel]');
    const $zwo=el.querySelector('[data-zwo]'), $del=el.querySelector('[data-del]');
    const $d_ftp=el.querySelector('[data-d-ftp]'), $d_sets=el.querySelector('[data-d-sets]'), $d_work=el.querySelector('[data-d-work]');
    const $d_rec=el.querySelector('[data-d-rec]'), $d_target=el.querySelector('[data-d-target]'), $d_ou=el.querySelector('[data-d-ou]');
    const $d_under=el.querySelector('[data-d-under]'), $d_over=el.querySelector('[data-d-over]');
    const $d_warm=el.querySelector('[data-d-warm]'), $d_cool=el.querySelector('[data-d-cool]'), $d_cad=el.querySelector('[data-d-cad]'), $d_erg=el.querySelector('[data-d-erg]');

    $name.value=w.name||''; $type.value=w.type||'Ride'; $ind.checked=!!w.indoor;
    $dur.value=hhmmFromSec(w.duration_sec||0); $tss.value=Number.isFinite(w.tss)?w.tss:0; $notes.value=w.notes||'';
    $name.addEventListener('input',()=>{w.name=$name.value; save();}); 
    $type.addEventListener('change',()=>{w.type=$type.value; save(); totals();});
    $ind.addEventListener('change',()=>{w.indoor=$ind.checked; save();});
    $dur.addEventListener('change',()=>{w.duration_sec=parseHHMM($dur.value); save(); totals();});
    $tss.addEventListener('change',()=>{w.tss=Math.max(0,parseFloat($tss.value||'0')); save(); totals();});
    $notes.addEventListener('input',()=>{w.notes=$notes.value; save();});

    const d=w.design||{};
    $d_ftp.value=d.ftp_watts??''; $d_sets.value=d.sets??3; $d_work.value=d.work_sec??720; $d_rec.value=d.rec_sec??300;
    $d_target.value=d.target_pct ?? defaultTargetPctByName(w.name||''); $d_ou.checked=!!d.overunder;
    $d_under.value=d.under_pct??''; $d_over.value=d.over_pct??'';
    $d_warm.value=d.warmup_sec??600; $d_cool.value=d.cooldown_sec??600; $d_cad.value=d.cadence??''; $d_erg.checked=(d.erg??true);

    const toggle=show=>$panel.classList.toggle('hidden', !show);
    $designBtn.addEventListener('click',()=>{ toggle($panel.classList.contains('hidden')); });
    el.querySelector('[data-design-cancel]').addEventListener('click',()=>toggle(false));
    el.querySelector('[data-design-save]').addEventListener('click',()=>{
      const obj={
        kind:(/sweet\s*spot/i.test($name.value||""))?"sweetspot":(/threshold/i.test($name.value||""))?"threshold":(/vo2/i.test($name.value||""))?"vo2":(/anaerobic|sprint/i.test($name.value||""))?"anaerobic":"custom",
        ftp_watts:numOrNull($d_ftp.value), sets:numOrNull($d_sets.value)??3, work_sec:numOrNull($d_work.value)??720, rec_sec:numOrNull($d_rec.value)??300,
        target_pct:numOrNull($d_target.value)??defaultTargetPctByName($name.value||""), overunder:$d_ou.checked,
        under_pct:numOrNull($d_under.value)||undefined, over_pct:numOrNull($d_over.value)||undefined,
        warmup_sec:numOrNull($d_warm.value)||600, cooldown_sec:numOrNull($d_cool.value)||600, cadence:numOrNull($d_cad.value)||undefined, erg:!!$d_erg.checked
      };
      for(const k of Object.keys(obj)) if(obj[k]===null) delete obj[k];
      w.design=obj; save(); toggle(false);
    });

    $zwo.addEventListener('click',()=>{
      try{
        if(!w.indoor && !confirm("Not marked Indoor. Generate ZWO anyway?")) return;
        if(/endurance\s*z?2/i.test(w.name||"")){ alert("Skipping Z2 endurance for ZWO."); return; }
        const xml=makeZwoXml(w);
        const safe=safeFilename(`${iso} - ${w.name||'Workout'}`).replace(/\.zwo$/i,'')+'.zwo';
        const cfg=ghGetCfg();
        if(cfg.token && confirm("Upload .zwo to your repo? (Cancel = download only)")){
          const path=`zwo/${safe}`; githubPutFile(cfg,path,xml,`feat(zwo): ${safe}`).then(()=>alert(`Uploaded ✓ ${path}`)).catch(e=>alert(`Upload failed: ${e.message||e}`));
        }else{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([xml],{type:'application/xml'})); a.download=safe; a.click(); URL.revokeObjectURL(a.href); }
      }catch(e){ alert(`ZWO generation failed: ${e.message||e}`); }
    });

    $del.addEventListener('click',()=>{
      const list=state.days[iso]||[]; const idx=list.indexOf(w);
      if(idx>=0){ list.splice(idx,1); el.remove(); totals(); save(); }
    });

    return frag;
  }

  function totals(){
    let sec=0,tss=0; const byType=new Map();
    Object.values(state.days).forEach(list=>{
      list.forEach(w=>{ sec+=(w.duration_sec||0); tss+=(w.tss||0);
        const k=w.type||'Ride'; const cur=byType.get(k)||{sec:0,tss:0}; cur.sec+=(w.duration_sec||0); cur.tss+=(w.tss||0); byType.set(k,cur); });
    });
    $('#totPlannedTime').textContent=fmtHMS(sec);
    $('#totPlannedTss').textContent=Math.round(tss);
    $('#totByType').innerHTML=byType.size?Array.from(byType.entries()).map(([k,v])=>`<div><span class="font-medium">${k}</span>: ${fmtHMS(v.sec)}, TSS ${Math.round(v.tss)}</div>`).join(''):'—';
  }

  // ---------- Export / Import / Load ----------
  function buildPayload(){
    const out={version:1,tz:state.tz,athlete_id:Number(state.athleteId||0),week_start:state.weekStart,workouts:[]};
    Object.entries(state.days).forEach(([date,list])=>{
      list.forEach(w=>{
        const wo={date,name:w.name||'',type:w.type||'Ride',indoor:!!w.indoor,duration_sec:Number(w.duration_sec||0),tss:Number(w.tss||0),notes:w.notes||''};
        if(w.design && typeof w.design==='object' && Object.keys(w.design).length) wo.design=w.design;
        out.workouts.push(wo);
      });
    });
    return out;
  }
  function exportJson(){ if(!state.weekStart){ alert('Choose a week start first.'); return; }
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(buildPayload(),null,2)],{type:'application/json'})); a.download=`plan-${state.weekStart}.json`; a.click(); URL.revokeObjectURL(a.href); }
  async function importJson(file){
    if(!file) return; const text=await file.text(); let data;
    try{ data=JSON.parse(text); }catch{ alert('Invalid JSON'); return; }
    if(!data || !data.week_start || !Array.isArray(data.workouts)){ alert('Missing fields'); return;}
    applyPlanData(data);
  }
  function applyPlanData(data){
    state.weekStart=data.week_start; $('#weekStart').value=state.weekStart;
    state.tz=data.tz||state.tz; $('#tz').value=state.tz;
    state.athleteId=(data.athlete_id ?? state.athleteId); $('#athleteId').value=state.athleteId;
    state.days={}; data.workouts.forEach(w=>{ (state.days[w.date] ||= []).push({name:w.name||'',type:w.type||'Ride',indoor:!!w.indoor,duration_sec:Number(w.duration_sec||0),tss:Number(w.tss||0),notes:w.notes||'',design:(w.design&&typeof w.design==='object')?w.design:undefined}); });
    save(); renderWeek();
  }
  async function refreshPlanList(){
    const msg=$('#loadPlanMsg'); msg.textContent='Loading…';
    try{
      const cfg=ghGetCfg(); cfg.token=cleanToken(cfg.token||'');
      const prefix=(cfg.prefix||'plans').replace(/^\/+|\/+$/g,'');
      const items=await ghListPlans(cfg,prefix);
      const sel=$('#loadPlanSelect'); sel.innerHTML='<option value="">— select plan —</option>';
      items.sort((a,b)=>b.name.localeCompare(a.name)).forEach(it=>{
        const o=document.createElement('option'); o.value=it.path; o.textContent=it.name.replace(/^plan-/,'').replace(/\.json$/,''); sel.appendChild(o);
      });
      msg.textContent=`${items.length} plan(s) in ${prefix}/`;
    }catch(e){ msg.textContent=`Error: ${e.message||e}`; showErr(e.message||e); }
  }
  async function loadSelectedPlan(){
    const path=$('#loadPlanSelect').value; if(!path){ alert('Pick a plan first.'); return; }
    try{
      const cfg=ghGetCfg(); const data=await ghGetJsonFile(cfg,path); applyPlanData(data);
      const link=$('#openPlanLink'); link.href=`https://github.com/${cfg.owner}/${cfg.repo}/blob/${encodeURIComponent(cfg.branch)}/${path}`;
      $('#loadPlanMsg').textContent=`Loaded ${path}`;
    }catch(e){ alert(`Load failed: ${e.message||e}`); }
  }

  // ---------- Upload to Intervals ----------
  async function saveThenUpload(){
    if(!state.weekStart){ alert('Pick a week start first.'); return; }
    const cfg=ghGetCfg(); const prefix=(cfg.prefix||'plans').replace(/^\/+|\/+$/g,''); const path=`${prefix}/plan-${state.weekStart}.json`;
    await githubPutFile(cfg, path, JSON.stringify(buildPayload(),null,2), `feat(planner): save ${path}`);
    await ghDispatchWorkflow(cfg, 'upload-week-plan.yml', {plan_path:path, tz:state.tz||'America/Los_Angeles', athlete_id:String(state.athleteId||0), default_start:'06:00', dry_run:'false'});
    alert('Upload started ✓ (check Actions).');
  }

  // ---------- Minimal ZWO ----------
  function makeZwoXml(w){
    const name=w.name||"Workout";
    if(/endurance\s*z?2/i.test(name)) throw new Error('Endurance Z2 not converted to ZWO.');
    const d=w.design||{}; const warm=d.warmup_sec??600, cool=d.cooldown_sec??600;
    const sets=Math.max(1,parseInt(d.sets??3,10)), work=Math.max(15,parseInt(d.work_sec??720,10)), rec=Math.max(10,parseInt(d.rec_sec??300,10));
    const pct=(d.target_pct!=null?d.target_pct:defaultTargetPctByName(name));
    const steps=[`<Warmup Duration="${warm}" PowerLow="0.5" PowerHigh="0.75"/>`,
                 `<IntervalsT Repeat="${sets}" OnDuration="${work}" OffDuration="${rec}" OnPower="${pct}" OffPower="0.55" Cadence="0"/>`,
                 `<Cooldown Duration="${cool}" PowerLow="0.5" PowerHigh="0.75"/>`];
    const esc=s=>String(s).replace(/[<>&'"]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;'}[c]));
    return `<?xml version="1.0" encoding="UTF-8"?>
<workout_file>
  <author>planner</author>
  <name>${esc(name)}</name>
  <description>Auto-generated from planner</description>
  <sportType>bike</sportType>
  <tags></tags>
  <workout>
    ${steps.join('\n    ')}
  </workout>
</workout_file>`;
  }

  // ---------- Events / Boot ----------
  function setWeekStartFromInput(){
    const raw=$('#weekStart').value; if(!raw) return;
    const iso=toISODate(mondayOf(raw)); $('#weekStart').value=iso; state.weekStart=iso;
    const prev=loadWeek(iso); if(prev){ state.tz=prev.tz||state.tz; $('#tz').value=state.tz; state.athleteId=(prev.athleteId??state.athleteId); $('#athleteId').value=state.athleteId; state.days=prev.days||{}; }
    else { state.days={}; }
    save(); renderWeek();
  }

  (function boot(){
    try{
      $('#weekStart').addEventListener('change', setWeekStartFromInput);
      $('#tz').addEventListener('change',()=>{ state.tz=$('#tz').value; save(); });
      $('#athleteId').addEventListener('change',()=>{ state.athleteId=Number($('#athleteId').value||0); save(); });
      $('#newWeekBtn').addEventListener('click',()=>{ if(!$('#weekStart').value){ alert('Pick a Monday to start.'); return; } state.days={}; save(); renderWeek(); });
      $('#exportBtn').addEventListener('click', exportJson);
      $('#importFile').addEventListener('change', e=>importJson(e.target.files[0]));
      $('#saveRepoBtn').addEventListener('click', async ()=>{
        if(!state.weekStart){ alert('Pick a week start first.'); return; }
        const cfg=ghGetCfg(); const prefix=(cfg.prefix||'plans').replace(/^\/+|\/+$/g,''); const path=`${prefix}/plan-${state.weekStart}.json`;
        await githubPutFile(cfg, path, JSON.stringify(buildPayload(),null,2), `feat(planner): save ${path}`); alert(`Saved ✓ ${path}`);
      });
      $('#uploadIntervalsBtn').addEventListener('click', saveThenUpload);
      $('#saveGhCfg').addEventListener('click', ()=>{
        const cfg={token:cleanToken($('#ghToken').value),owner:$('#ghOwner').value,repo:$('#ghRepo').value,branch:$('#ghBranch').value,prefix:$('#ghPrefix').value};
        ghSaveCfg(cfg); $('#ghToken').value=cfg.token; $('#saveGhMsg').textContent='Saved ✓'; setTimeout(()=>$('#saveGhMsg').textContent='',2500);
      });
      $('#clearGhCfg').addEventListener('click', ()=>{ localStorage.removeItem(GH_STORE_KEY); if($('#ghToken')) $('#ghToken').value=''; $('#saveGhMsg').textContent='Cleared'; setTimeout(()=>$('#saveGhMsg').textContent='',2000); });
      $('#phase').addEventListener('change', updateTemplateList);
      $('#focus').addEventListener('change', updateTemplateList);
      $('#templateKey').addEventListener('change', ()=>{
        const phase=$('#phase').value, focus=$('#focus').value, key=$('#templateKey').value;
        const g=TEMPLATES[phase]&&TEMPLATES[phase][focus]?TEMPLATES[phase][focus]:null;
        $('#templateDesc').textContent=(g&&g[key]&&g[key].desc)?g[key].desc:'';
      });
      $('#loadTemplateBtn').addEventListener('click', applyTemplate);
      $('#refreshPlansBtn').addEventListener('click', refreshPlanList);
      $('#loadPlanBtn').addEventListener('click', loadSelectedPlan);
      $('#testGhBtn').addEventListener('click', async ()=>{
        try{
          const cfg=ghGetCfg(); const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
          const res=await ghFetch(url, cfg.token);
          const ok=res.ok; const js=await res.json();
          $('#loadPlanMsg').textContent= ok ? `GitHub OK: default_branch=${js.default_branch}` : `GitHub ERROR ${res.status}`;
        }catch(e){ $('#loadPlanMsg').textContent=`GitHub ERROR: ${e.message||e}`; }
      });

      // boot defaults
      const isoMonday=toISODate(mondayOf(new Date())); $('#weekStart').value=isoMonday; setWeekStartFromInput();
      updateTemplateList();
      refreshPlanList(); // will fall back to unauthenticated if public
    }catch(e){ showErr(e.message||e); }
  })();
  </script>
</body>
</html>
